//=============================================================================
// Tian Observing and Control System Framework
//
// Copyright (c) 2012, TIAN YANTAO
// All rights reserved.
//
// Redistribution and use in source and binary forms, with or without
// modification, are permitted provided that the following conditions are met:
//     * Redistributions of source code must retain the above copyright
//       notice, this list of conditions and the following disclaimer.
//     * Redistributions in binary form must reproduce the above copyright
//       notice, this list of conditions and the following disclaimer in the
//       documentation and/or other materials provided with the distribution.
//     * Neither the name of the TIAN nor the
//       names of its contributors may be used to endorse or promote products
//       derived from this software without specific prior written permission.
//
// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
// AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
// ARE DISCLAIMED. IN NO EVENT SHALL TIAN YANTAO BE LIABLE FOR ANY
// DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
// (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
// LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
// ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
// THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
//
// Contains portions of OpenLayers.js:
// http://svn.openlayers.org/trunk/openlayers/license.txt
//
// Contains portions of jQuery.js:
// http://jquery.org/license
//
// Contains portions of Require.js:
// https://github.com/jrburke/requirejs/blob/master/LICENSE
//
// Contains portions of binary.js:
// http://ats.oka.nu/titaniumcore/js/tools/binary.readme.txt
//
// Contains portions of Node.js:
// https://raw.github.com/joyent/node/v0.6.18/LICENSE
//-----------------------------------------------------------------------------
var Tian={};Tian.VERSION="1.1";Tian.BROWSER=(function(){var name="";var ua=navigator.userAgent.toLowerCase();if(ua.indexOf("opera")!=-1){name="opera";}else if(ua.indexOf("msie")!=-1){name="msie";}else if(ua.indexOf("safari")!=-1){name="safari";}else if(ua.indexOf("mozilla")!=-1){if(ua.indexOf("firefox")!=-1){name="firefox";}else{name="mozilla";}}
return name;})();Tian.ISGECKO=(function(){var ua=navigator.userAgent.toLowerCase();return ua.indexOf("webkit")==-1&&ua.indexOf("gecko")!=-1;})();Tian.createUniqueID=(function(){var ids={};return function(prefix){prefix=prefix||'txID_';prefix+='';if(typeof ids[prefix]!=='number'){ids[prefix]=0;}
ids[prefix]+=1;return prefix+ids[prefix];}})();Tian.getScriptLocation=function(file,doc){doc=doc||document;if(typeof doc.getElementsByTagName!=='function'){return'';}
var r,s,src,m,l="";if(typeof file==='string'){r=new RegExp("(^|(.*?\\/))("+file+")(\\?|$)");}else{r=new RegExp("(^|(.*?\\/))(tian-"+Tian.VERSION+".min.js)(\\?|$)");}
s=doc.getElementsByTagName('script');for(var i=0,len=s.length;i<len;i++){src=s[i].getAttribute('src');if(src){var m=src.match(r);if(m){l=m[1];break;}}}
return l;};Tian.getElement=function(){var elements=[];for(var i=0,len=arguments.length;i<len;i++){var element=arguments[i];if(typeof element=='string'){element=document.getElementById(element);}
if(arguments.length==1){return element;}
elements.push(element);}
return elements;};Tian.getStyle=function(element,style){element=Tian.getElement(element);var value=null;if(element&&element.style){value=element.style[Tian.String.camelize(style)];if(!value){if(document.defaultView&&document.defaultView.getComputedStyle){var css=document.defaultView.getComputedStyle(element,null);value=css?css.getPropertyValue(style):null;}else if(element.currentStyle){value=element.currentStyle[Tian.String.camelize(style)];}}
var positions=['left','top','right','bottom'];if(window.opera&&(Tian.Array.indexOf(positions,style)!=-1)&&(Tian.getStyle(element,'position')=='static')){value='auto';}}
return value=='auto'?null:value;};Tian.getViewportElement=function(){var viewportElement=arguments.callee.viewportElement;if(viewportElement==undefined){viewportElement=(Tian.BROWSER=="msie"&&document.compatMode!='CSS1Compat')?document.body:document.documentElement;arguments.callee.viewportElement=viewportElement;}
return viewportElement;};Tian.pagePosition=function(forElement){var pos=[0,0];var viewportElement=Tian.getViewportElement();if(!forElement||forElement==window||forElement==viewportElement){return pos;}
var BUGGY_GECKO_BOX_OBJECT=Tian.ISGECKO&&document.getBoxObjectFor&&Tian.getStyle(forElement,'position')=='absolute'&&(forElement.style.top==''||forElement.style.left=='');var parent=null;var box;if(forElement.getBoundingClientRect){box=forElement.getBoundingClientRect();var scrollTop=viewportElement.scrollTop;var scrollLeft=viewportElement.scrollLeft;pos[0]=box.left+scrollLeft;pos[1]=box.top+scrollTop;}else if(document.getBoxObjectFor&&!BUGGY_GECKO_BOX_OBJECT){box=document.getBoxObjectFor(forElement);var vpBox=document.getBoxObjectFor(viewportElement);pos[0]=box.screenX-vpBox.screenX;pos[1]=box.screenY-vpBox.screenY;}else{pos[0]=forElement.offsetLeft;pos[1]=forElement.offsetTop;parent=forElement.offsetParent;if(parent!=forElement){while(parent){pos[0]+=parent.offsetLeft;pos[1]+=parent.offsetTop;parent=parent.offsetParent;}}
var browser=Tian.BROWSER;if(browser=="opera"||(browser=="safari"&&Tian.getStyle(forElement,'position')=='absolute')){pos[1]-=document.body.offsetTop;}
parent=forElement.offsetParent;while(parent&&parent!=document.body){pos[0]-=parent.scrollLeft;if(browser!="opera"||parent.tagName!='TR'){pos[1]-=parent.scrollTop;}
parent=parent.offsetParent;}}
return pos;};Tian.extend=function(destination,source){destination=destination||{};if(source){for(var property in source){var value=source[property];if(value!==undefined){destination[property]=value;}}
var sourceIsEvt=typeof window.Event=="function"&&source instanceof window.Event;if(!sourceIsEvt&&source.hasOwnProperty&&source.hasOwnProperty("toString")){destination.toString=source.toString;}}
return destination;};Tian.applyDefaults=function(to,from){to=to||{};var fromIsEvt=typeof window.Event=="function"&&from instanceof window.Event;for(var key in from){if(to[key]===undefined||(!fromIsEvt&&from.hasOwnProperty&&from.hasOwnProperty(key)&&!to.hasOwnProperty(key))){to[key]=from[key];}}
if(!fromIsEvt&&from&&from.hasOwnProperty&&from.hasOwnProperty('toString')&&!to.hasOwnProperty('toString')){to.toString=from.toString;}
return to;};(function(global){'use strict';function safe_add(x,y){var lsw=(x&0xFFFF)+(y&0xFFFF),msw=(x>>16)+(y>>16)+(lsw>>16);return(msw<<16)|(lsw&0xFFFF);}
function bit_rol(num,cnt){return(num<<cnt)|(num>>>(32-cnt));}
function md5_cmn(q,a,b,x,s,t){return safe_add(bit_rol(safe_add(safe_add(a,q),safe_add(x,t)),s),b);}
function md5_ff(a,b,c,d,x,s,t){return md5_cmn((b&c)|((~b)&d),a,b,x,s,t);}
function md5_gg(a,b,c,d,x,s,t){return md5_cmn((b&d)|(c&(~d)),a,b,x,s,t);}
function md5_hh(a,b,c,d,x,s,t){return md5_cmn(b^c^d,a,b,x,s,t);}
function md5_ii(a,b,c,d,x,s,t){return md5_cmn(c^(b|(~d)),a,b,x,s,t);}
function binl_md5(x,len){x[len>>5]|=0x80<<((len)%32);x[(((len+64)>>>9)<<4)+14]=len;var i,olda,oldb,oldc,oldd,a=1732584193,b=-271733879,c=-1732584194,d=271733878;for(i=0;i<x.length;i+=16){olda=a;oldb=b;oldc=c;oldd=d;a=md5_ff(a,b,c,d,x[i],7,-680876936);d=md5_ff(d,a,b,c,x[i+1],12,-389564586);c=md5_ff(c,d,a,b,x[i+2],17,606105819);b=md5_ff(b,c,d,a,x[i+3],22,-1044525330);a=md5_ff(a,b,c,d,x[i+4],7,-176418897);d=md5_ff(d,a,b,c,x[i+5],12,1200080426);c=md5_ff(c,d,a,b,x[i+6],17,-1473231341);b=md5_ff(b,c,d,a,x[i+7],22,-45705983);a=md5_ff(a,b,c,d,x[i+8],7,1770035416);d=md5_ff(d,a,b,c,x[i+9],12,-1958414417);c=md5_ff(c,d,a,b,x[i+10],17,-42063);b=md5_ff(b,c,d,a,x[i+11],22,-1990404162);a=md5_ff(a,b,c,d,x[i+12],7,1804603682);d=md5_ff(d,a,b,c,x[i+13],12,-40341101);c=md5_ff(c,d,a,b,x[i+14],17,-1502002290);b=md5_ff(b,c,d,a,x[i+15],22,1236535329);a=md5_gg(a,b,c,d,x[i+1],5,-165796510);d=md5_gg(d,a,b,c,x[i+6],9,-1069501632);c=md5_gg(c,d,a,b,x[i+11],14,643717713);b=md5_gg(b,c,d,a,x[i],20,-373897302);a=md5_gg(a,b,c,d,x[i+5],5,-701558691);d=md5_gg(d,a,b,c,x[i+10],9,38016083);c=md5_gg(c,d,a,b,x[i+15],14,-660478335);b=md5_gg(b,c,d,a,x[i+4],20,-405537848);a=md5_gg(a,b,c,d,x[i+9],5,568446438);d=md5_gg(d,a,b,c,x[i+14],9,-1019803690);c=md5_gg(c,d,a,b,x[i+3],14,-187363961);b=md5_gg(b,c,d,a,x[i+8],20,1163531501);a=md5_gg(a,b,c,d,x[i+13],5,-1444681467);d=md5_gg(d,a,b,c,x[i+2],9,-51403784);c=md5_gg(c,d,a,b,x[i+7],14,1735328473);b=md5_gg(b,c,d,a,x[i+12],20,-1926607734);a=md5_hh(a,b,c,d,x[i+5],4,-378558);d=md5_hh(d,a,b,c,x[i+8],11,-2022574463);c=md5_hh(c,d,a,b,x[i+11],16,1839030562);b=md5_hh(b,c,d,a,x[i+14],23,-35309556);a=md5_hh(a,b,c,d,x[i+1],4,-1530992060);d=md5_hh(d,a,b,c,x[i+4],11,1272893353);c=md5_hh(c,d,a,b,x[i+7],16,-155497632);b=md5_hh(b,c,d,a,x[i+10],23,-1094730640);a=md5_hh(a,b,c,d,x[i+13],4,681279174);d=md5_hh(d,a,b,c,x[i],11,-358537222);c=md5_hh(c,d,a,b,x[i+3],16,-722521979);b=md5_hh(b,c,d,a,x[i+6],23,76029189);a=md5_hh(a,b,c,d,x[i+9],4,-640364487);d=md5_hh(d,a,b,c,x[i+12],11,-421815835);c=md5_hh(c,d,a,b,x[i+15],16,530742520);b=md5_hh(b,c,d,a,x[i+2],23,-995338651);a=md5_ii(a,b,c,d,x[i],6,-198630844);d=md5_ii(d,a,b,c,x[i+7],10,1126891415);c=md5_ii(c,d,a,b,x[i+14],15,-1416354905);b=md5_ii(b,c,d,a,x[i+5],21,-57434055);a=md5_ii(a,b,c,d,x[i+12],6,1700485571);d=md5_ii(d,a,b,c,x[i+3],10,-1894986606);c=md5_ii(c,d,a,b,x[i+10],15,-1051523);b=md5_ii(b,c,d,a,x[i+1],21,-2054922799);a=md5_ii(a,b,c,d,x[i+8],6,1873313359);d=md5_ii(d,a,b,c,x[i+15],10,-30611744);c=md5_ii(c,d,a,b,x[i+6],15,-1560198380);b=md5_ii(b,c,d,a,x[i+13],21,1309151649);a=md5_ii(a,b,c,d,x[i+4],6,-145523070);d=md5_ii(d,a,b,c,x[i+11],10,-1120210379);c=md5_ii(c,d,a,b,x[i+2],15,718787259);b=md5_ii(b,c,d,a,x[i+9],21,-343485551);a=safe_add(a,olda);b=safe_add(b,oldb);c=safe_add(c,oldc);d=safe_add(d,oldd);}
return[a,b,c,d];}
function binl2rstr(input){var i,output='';for(i=0;i<input.length*32;i+=8){output+=String.fromCharCode((input[i>>5]>>>(i%32))&0xFF);}
return output;}
function rstr2binl(input){var i,output=[];output[(input.length>>2)-1]=undefined;for(i=0;i<output.length;i+=1){output[i]=0;}
for(i=0;i<input.length*8;i+=8){output[i>>5]|=(input.charCodeAt(i/8)&0xFF)<<(i%32);}
return output;}
function rstr_md5(s){return binl2rstr(binl_md5(rstr2binl(s),s.length*8));}
function rstr_hmac_md5(key,data){var i,bkey=rstr2binl(key),ipad=[],opad=[],hash;ipad[15]=opad[15]=undefined;if(bkey.length>16){bkey=binl_md5(bkey,key.length*8);}
for(i=0;i<16;i+=1){ipad[i]=bkey[i]^0x36363636;opad[i]=bkey[i]^0x5C5C5C5C;}
hash=binl_md5(ipad.concat(rstr2binl(data)),512+data.length*8);return binl2rstr(binl_md5(opad.concat(hash),512+128));}
function rstr2hex(input){var hex_tab='0123456789abcdef',output='',x,i;for(i=0;i<input.length;i+=1){x=input.charCodeAt(i);output+=hex_tab.charAt((x>>>4)&0x0F)+
hex_tab.charAt(x&0x0F);}
return output;}
function str2rstr_utf8(input){return unescape(encodeURIComponent(input));}
function raw_md5(s){return rstr_md5(str2rstr_utf8(s));}
function hex_md5(s){return rstr2hex(raw_md5(s));}
function raw_hmac_md5(k,d){return rstr_hmac_md5(str2rstr_utf8(k),str2rstr_utf8(d));}
function hex_hmac_md5(k,d){return rstr2hex(raw_hmac_md5(k,d));}
function md5(string,key,raw){if(!key){if(!raw){return hex_md5(string);}else{return raw_md5(string);}}
if(!raw){return hex_hmac_md5(key,string);}else{return raw_hmac_md5(key,string);}}
global.md5=md5;})(window.Tian);Tian.Array={isArray:function(obj){if(typeof Array.isArray==='function'){return Array.isArray(obj);}else{return Object.prototype.toString.call(obj)==='[object Array]';}},indexOf:function(array,obj){if(typeof array.indexOf==="function"){return array.indexOf(obj);}else{for(var i=0,len=array.length;i<len;i++){if(array[i]==obj){return i;}}
return-1;}},removeItem:function(array,item){for(var i=array.length-1;i>=0;i--){if(array[i]==item){array.splice(i,1);}}
return array;},filter:function(array,callback,caller){var selected=[];if(Array.prototype.filter){selected=array.filter(callback,caller);}else{var len=array.length;if(typeof callback!="function"){throw new TypeError();}
for(var i=0;i<len;i++){if(i in array){var val=array[i];if(callback.call(caller,val,i,array)){selected.push(val);}}}}
return selected;}};Tian.String={startsWith:function(str,sub){return(str.indexOf(sub)==0);},contains:function(str,sub){return(str.indexOf(sub)!=-1);},trim:function(str){return str.replace(/^\s\s*/,'').replace(/\s\s*$/,'');},camelize:function(str){var oStringList=str.split('-');var camelizedString=oStringList[0];for(var i=1,len=oStringList.length;i<len;i++){var s=oStringList[i];camelizedString+=s.charAt(0).toUpperCase()+s.substring(1);}
return camelizedString;},format:function(template,context,args){context=context||window;var tokenRegEx=/\$\{([\w.]+?)\}/g;var replacer=function(str,match){var replacement;var subs=match.split(/\.+/);for(var i=0;i<subs.length;i++){if(i==0){replacement=context;}
replacement=replacement[subs[i]];}
if(typeof replacement=="function"){replacement=args?replacement.apply(null,args):replacement();}
if(typeof replacement=='undefined'){return'undefined';}else{return replacement;}};return template.replace(tokenRegEx,replacer);},isNumeric:function(value){var numberRegEx=/^([+-]?)(?=\d|\.\d)\d*(\.\d*)?([Ee]([+-]?\d+))?$/;return numberRegEx.test(value);},numericIf:function(value){return Tian.String.isNumeric(value)?parseFloat(value):value;},isEmail:function(email){var emailRegEx=/^([\w\d_\.-]+)@([\w\d_-]+\.)+\w{2,5}$/;return emailRegEx.test(email);},isURL:function(url){var urlRegEx=/^(https?:\/\/)?([\w\d_-]+\.)+\w{2,5}(\/[\w\d\.\?-_%=&]+)*$/;return urlRegEx.test(url);},sprintf:function(){var regex=/%%|%(\d+\$)?([-+\'#0 ]*)(\*\d+\$|\*|\d+)?(\.(\*\d+\$|\*|\d+))?([scboxXuideEfFgG])/g;var a=arguments,i=0,format=a[i++];var pad=function(str,len,chr,leftJustify){if(!chr){chr=' ';}
var padding=(str.length>=len)?'':Array(1+len-str.length>>>0).join(chr);return leftJustify?str+padding:padding+str;};var justify=function(value,prefix,leftJustify,minWidth,zeroPad,customPadChar){var diff=minWidth-value.length;if(diff>0){if(leftJustify||!zeroPad){value=pad(value,minWidth,customPadChar,leftJustify);}else{value=value.slice(0,prefix.length)+pad('',diff,'0',true)+value.slice(prefix.length);}}
return value;};var formatBaseX=function(value,base,prefix,leftJustify,minWidth,precision,zeroPad){var number=value>>>0;prefix=prefix&&number&&{'2':'0b','8':'0','16':'0x'}[base]||'';value=prefix+pad(number.toString(base),precision||0,'0',false);return justify(value,prefix,leftJustify,minWidth,zeroPad);};var formatString=function(value,leftJustify,minWidth,precision,zeroPad,customPadChar){if(precision!=null){value=value.slice(0,precision);}
return justify(value,'',leftJustify,minWidth,zeroPad,customPadChar);};var doFormat=function(substring,valueIndex,flags,minWidth,_,precision,type){var number;var prefix;var method;var textTransform;var value;if(substring=='%%'){return'%';}
var leftJustify=false,positivePrefix='',zeroPad=false,prefixBaseX=false,customPadChar=' ';var flagsl=flags.length;for(var j=0;flags&&j<flagsl;j++){switch(flags.charAt(j)){case' ':positivePrefix=' ';break;case'+':positivePrefix='+';break;case'-':leftJustify=true;break;case"'":customPadChar=flags.charAt(j+1);break;case'0':zeroPad=true;break;case'#':prefixBaseX=true;break;}}
if(!minWidth){minWidth=0;}else if(minWidth=='*'){minWidth=+a[i++];}else if(minWidth.charAt(0)=='*'){minWidth=+a[minWidth.slice(1,-1)];}else{minWidth=+minWidth;}
if(minWidth<0){minWidth=-minWidth;leftJustify=true;}
if(!isFinite(minWidth)){throw new Error('sprintf: (minimum-)width must be finite');}
if(!precision){precision='fFeE'.indexOf(type)>-1?6:(type=='d')?0:undefined;}else if(precision=='*'){precision=+a[i++];}else if(precision.charAt(0)=='*'){precision=+a[precision.slice(1,-1)];}else{precision=+precision;}
value=valueIndex?a[valueIndex.slice(0,-1)]:a[i++];switch(type){case's':return formatString(String(value),leftJustify,minWidth,precision,zeroPad,customPadChar);case'c':return formatString(String.fromCharCode(+value),leftJustify,minWidth,precision,zeroPad);case'b':return formatBaseX(value,2,prefixBaseX,leftJustify,minWidth,precision,zeroPad);case'o':return formatBaseX(value,8,prefixBaseX,leftJustify,minWidth,precision,zeroPad);case'x':return formatBaseX(value,16,prefixBaseX,leftJustify,minWidth,precision,zeroPad);case'X':return formatBaseX(value,16,prefixBaseX,leftJustify,minWidth,precision,zeroPad).toUpperCase();case'u':return formatBaseX(value,10,prefixBaseX,leftJustify,minWidth,precision,zeroPad);case'i':case'd':number=+value||0;number=Math.round(number-number%1);prefix=number<0?'-':positivePrefix;value=prefix+pad(String(Math.abs(number)),precision,'0',false);return justify(value,prefix,leftJustify,minWidth,zeroPad);case'e':case'E':case'f':case'F':case'g':case'G':number=+value;prefix=number<0?'-':positivePrefix;method=['toExponential','toFixed','toPrecision']['efg'.indexOf(type.toLowerCase())];textTransform=['toString','toUpperCase']['eEfFgG'.indexOf(type)%2];value=prefix+Math.abs(number)[method](precision);return justify(value,prefix,leftJustify,minWidth,zeroPad)[textTransform]();default:return substring;}};return format.replace(regex,doFormat);},sscanf:function(str,format){var retArr=[],num=0,_NWS=/\S/,args=arguments,that=this,digit;var _setExtraConversionSpecs=function(offset){var matches=format.slice(offset).match(/%[cdeEufgosxX]/g);if(matches){var lgth=matches.length;while(lgth--){retArr.push(null);}}
return _finish();};var _finish=function(){if(args.length===2){return retArr;}
for(var i=0;i<retArr.length;++i){that.window[args[i+2]]=retArr[i];}
return i;};var _addNext=function(j,regex,cb){if(assign){var remaining=str.slice(j);var check=width?remaining.substr(0,width):remaining;var match=regex.exec(check);var testNull=retArr[digit!==undefined?digit:retArr.length]=match?(cb?cb.apply(null,match):match[0]):null;if(testNull===null){throw'No match in string';}
return j+match[0].length;}
return j;};if(arguments.length<2){throw'Not enough arguments passed to sscanf';}
for(var i=0,j=0;i<format.length;i++){var width=0,assign=true;if(format.charAt(i)==='%'){if(format.charAt(i+1)==='%'){if(str.charAt(j)==='%'){++i,++j;continue;}
return _setExtraConversionSpecs(i+2);}
var prePattern=new RegExp('^(?:(\\d+)\\$)?(\\*)?(\\d*)([hlL]?)','g');var preConvs=prePattern.exec(format.slice(i+1));var tmpDigit=digit;if(tmpDigit&&preConvs[1]===undefined){throw'All groups in sscanf() must be expressed as numeric if any have already been used';}
digit=preConvs[1]?parseInt(preConvs[1],10)-1:undefined;assign=!preConvs[2];width=parseInt(preConvs[3],10);var sizeCode=preConvs[4];i+=prePattern.lastIndex;if(sizeCode){switch(sizeCode){case'h':case'l':case'L':break;default:throw'Unexpected size specifier in sscanf()!';break;}}
try{switch(format.charAt(i+1)){case'F':break;case'g':break;case'G':break;case'b':break;case'i':j=_addNext(j,/([+-])?(?:(?:0x([\da-fA-F]+))|(?:0([0-7]+))|(\d+))/,function(num,sign,hex,oct,dec){return hex?parseInt(num,16):oct?parseInt(num,8):parseInt(num,10);});break;case'n':retArr[digit!==undefined?digit:retArr.length-1]=j;break;case'c':j=_addNext(j,new RegExp('.{1,'+(width||1)+'}'));break;case'D':case'd':j=_addNext(j,/([+-])?(?:0*)(\d+)/,function(num,sign,dec){var decInt=parseInt((sign||'')+dec,10);return decInt;});break;case'f':case'E':case'e':j=_addNext(j,/([+-])?(?:0*)(\d*\.?\d*(?:[eE]?\d+)?)/,function(num,sign,dec){if(dec==='.'){return null;}
return parseFloat((sign||'')+dec);});break;case'u':j=_addNext(j,/([+-])?(?:0*)(\d+)/,function(num,sign,dec){var decInt=parseInt(dec,10);if(sign==='-'){return 4294967296-decInt;}else{return decInt<4294967295?decInt:4294967295;}});break;case'o':j=_addNext(j,/([+-])?(?:0([0-7]+))/,function(num,sign,oct){return parseInt(num,8);});break;case's':j=_addNext(j,/\S+/);break;case'X':case'x':j=_addNext(j,/([+-])?(?:(?:0x)?([\da-fA-F]+))/,function(num,sign,hex){return parseInt(num,16);});break;case'':throw'Missing character after percent mark in sscanf() format argument';default:throw'Unrecognized character after percent mark in sscanf() format argument';}}catch(e){if(e==='No match in string'){return _setExtraConversionSpecs(i+2);}}++i;}else if(format.charAt(i)!==str.charAt(j)){_NWS.lastIndex=0;if((_NWS).test(str.charAt(j))||str.charAt(j)===''){return _setExtraConversionSpecs(i+1);}else{str=str.slice(0,j)+str.slice(j+1);i--;}}else{j++;}}
return _finish();}};Tian.Lang={code:null,defaultCode:"en",getCode:function(){if(!Tian.Lang.code){Tian.Lang.setCode();}
return Tian.Lang.code;},setCode:function(code){var lang;if(!code){code=(Tian.BROWSER=="msie")?navigator.userLanguage:navigator.language;}
var parts=code.split('-');parts[0]=parts[0].toLowerCase();if(typeof Tian.Lang[parts[0]]=="object"){lang=parts[0];}
if(parts[1]){var testLang=parts[0]+'-'+parts[1].toUpperCase();if(typeof Tian.Lang[testLang]=="object"){lang=testLang;}}
if(!lang){lang=Tian.Lang.defaultCode;}
Tian.Lang.code=lang;},translate:function(key){var dictionary=Tian.Lang[Tian.Lang.getCode()];var message=dictionary&&dictionary[key];if(!message){message=key;}
return message;},add:function(code,key,word){if(typeof Tian.Lang[code]!=='object'){Tian.Lang[code]={};}
if(typeof Tian.Lang[code][key]==='string'){return false;}
Tian.Lang[code][key]=word;return true;}};Tian.i18n=Tian.Lang.translate;Tian.inherit=function(C,P){var F=function(){};F.prototype=P.prototype;C.prototype=new F;var i,l,o;for(i=2,l=arguments.length;i<l;i++){o=arguments[i];if(typeof o==="function"){o=o.prototype;}
Tian.extend(C.prototype,o);}};Tian.Class=function(){var len=arguments.length;var P=arguments[0];var F=arguments[len-1];var C=typeof F.initialize==="function"?F.initialize:function(){P.apply(this,arguments);};if(len>1){var newArgs=[C,P].concat(Array.prototype.slice.call(arguments).slice(1,len-1),F);Tian.inherit.apply(null,newArgs);}else{C.prototype=F;}
return C;};Tian.Number={dsep:".",tsep:",",limitSigDigs:function(num,sig){var fig=0;if(sig>0){fig=parseFloat(num.toPrecision(sig));}
return fig;},limitFixDigs:function(num,fix){var fig=0;if(typeof fix==='number'){fig=parseFloat(num.toFixed(fix));}
return fig;},format:function(num,dec,tsep,dsep){dec=(typeof dec!="undefined")?dec:0;tsep=(typeof tsep!="undefined")?tsep:Tian.Number.tsep;dsep=(typeof dsep!="undefined")?dsep:Tian.Number.dsep;if(dec!=null){num=parseFloat(num.toFixed(dec));}
var parts=num.toString().split(".");if(parts.length==1&&dec==null){dec=0;}
var integer=parts[0];if(tsep){var thousands=/(-?[0-9]+)([0-9]{3})/;while(thousands.test(integer)){integer=integer.replace(thousands,"$1"+tsep+"$2");}}
var str;if(dec==0){str=integer;}else{var rem=parts.length>1?parts[1]:"0";if(dec!=null){rem=rem+new Array(dec-rem.length+1).join("0");}
str=integer+dsep+rem;}
return str;},zeroize:function(value,length){if(!length)length=2;value=value+'';for(var i=0,zeros='';i<(length-value.length);i++){zeros+='0';}
return zeros+value;}};Tian.Date={format:function(date,mask){if(!mask){return date.toString();}
var maskRegEx=/"[^"]*"|'[^']*'|\b(?:d{1,4}|m{1,4}|yy(?:yy)?|([hHMSlLtT])\1?|[lLZ])\b/g;return mask.replace(maskRegEx,function(tt){switch(tt){case'd':return date.getDate();case'dd':return Tian.Number.zeroize(date.getDate());case'm':return date.getMonth()+1;case'mm':return Tian.Number.zeroize(date.getMonth()+1);case'yy':return String(date.getFullYear()).substr(2);case'yyyy':return date.getFullYear();case'h':return date.getHours()%12||12;case'hh':return Tian.Number.zeroize(date.getHours()%12||12);case'H':return date.getHours();case'HH':return Tian.Number.zeroize(date.getHours());case'M':return date.getMinutes();case'MM':return Tian.Number.zeroize(date.getMinutes());case'S':return date.getSeconds();case'SS':return Tian.Number.zeroize(date.getSeconds());case'l':var m=date.getMilliseconds();if(m>99)m=Math.round(m/10);return Tian.Number.zeroize(m);case'L':return Tian.Number.zeroize(date.getMilliseconds(),3);default:return tt.substr(1,tt.length-2);}});},doy:function(date){if(!date){date=new Date();}
var dt=new Date(date.getFullYear(),0,1);return Math.ceil((date-dt)/86400000);}};(function($){'use strict';if(!$.JSON){$.JSON={};}
function f(n){return n<10?'0'+n:n;}
if(typeof Date.prototype.toJSON!=='function'){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+'-'+
f(this.getUTCMonth()+1)+'-'+
f(this.getUTCDate())+'T'+
f(this.getUTCHours())+':'+
f(this.getUTCMinutes())+':'+
f(this.getUTCSeconds())+'Z':null;};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf();};}
var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==='string'?c:'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);})+'"':'"'+string+'"';}
function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==='object'&&typeof value.toJSON==='function'){value=value.toJSON(key);}
if(typeof rep==='function'){value=rep.call(holder,key,value);}
switch(typeof value){case'string':return quote(value);case'number':return isFinite(value)?String(value):'null';case'boolean':case'null':return String(value);case'object':if(!value){return'null';}
gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==='[object Array]'){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||'null';}
v=partial.length===0?'[]':gap?'[\n'+gap+partial.join(',\n'+gap)+'\n'+mind+']':'['+partial.join(',')+']';gap=mind;return v;}
if(rep&&typeof rep==='object'){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==='string'){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}
v=partial.length===0?'{}':gap?'{\n'+gap+partial.join(',\n'+gap)+'\n'+mind+'}':'{'+partial.join(',')+'}';gap=mind;return v;}}
if(typeof $.JSON.stringify!=='function'){$.JSON.stringify=function(value,replacer,space){var i;gap='';indent='';if(typeof space==='number'){for(i=0;i<space;i+=1){indent+=' ';}}else if(typeof space==='string'){indent=space;}
rep=replacer;if(replacer&&typeof replacer!=='function'&&(typeof replacer!=='object'||typeof replacer.length!=='number')){throw new Error('Tian.JSON.stringify');}
return str('',{'':value});};}
if(typeof $.JSON.parse!=='function'){$.JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==='object'){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v;}else{delete value[k];}}}}
return reviver.call(holder,key,value);}
text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return'\\u'+
('0000'+a.charCodeAt(0).toString(16)).slice(-4);});}
if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,'@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,']').replace(/(?:^|:|,)(?:\s*\[)+/g,''))){j=eval('('+text+')');return typeof reviver==='function'?walk({'':j},''):j;}
throw new SyntaxError('Tian.JSON.parse');};}}(window.Tian));Tian.require=function(urls,callback,doc){doc=doc||document;var head=doc.getElementsByTagName("head")[0]||doc.documentElement;if(!head){callback&&callback.call(null,'error');return;}
if(typeof urls==='string'){urls=[urls];}
var count=0,dones=[],nodes=[];for(var i=0,len=urls.length;i<len;i++){if(typeof urls[i]==='string'){dones[i]=false;nodes[i]=doc.createElement('script');nodes[i].charset='utf-8';nodes[i].src=urls[i];nodes[i].onload=nodes[i].onreadystatechange=(function(idx){return function(){if(!dones[idx]&&(!nodes[idx].readyState||/loaded|complete/.test(nodes[idx].readyState))){dones[idx]=true;count+=1;nodes[idx].onload=nodes[idx].onreadystatechange=null;if(head&&nodes[idx].parentNode){head.removeChild(nodes[idx]);}
nodes[idx]=undefined;if(count===urls.length){callback&&callback.call(null);}}}}(i));head.insertBefore(nodes[i],head.firstChild);}}};Tian.requireCSS=function(url,callback,doc){doc=doc||document;var found=false;var allNodes=doc.getElementsByTagName('link');for(var i=0;i<allNodes.length;i++){if(allNodes[i]&&allNodes[i].href==url){found=true;break;}}
if(!found){var node=doc.createElement("link");node.type='text/css';node.rel='stylesheet';node.href=url;var head=doc.getElementsByTagName("head")[0]||doc.documentElement;head.insertBefore(node,head.firstChild);}
callback&&callback.call(null);};Tian.removeCSS=function(url,callback,doc){doc=doc||document;var allNodes=doc.getElementsByTagName('link');for(var i=allNodes.length;i>=0;i--){if(allNodes[i]&&allNodes[i].href!=null&&allNodes[i].href.indexOf(url)!=-1&&allNodes[i].parentNode){allNodes[i].parentNode.removeChild(allNodes[i]);}}
callback&&callback.call(null);};Tian.replaceCSS=function(oldurl,newurl,callback,doc){doc=doc||document;Tian.requireCSS(newurl,doc);Tian.removeCSS(oldurl,doc);callback&&callback.call(null);};(function(){var ss=document.getElementsByTagName('script'),grub=false;for(var i=0;i<ss.length;i++){grub=ss[i].getAttribute('data-grub');if(grub){Tian.require(grub);return;}}})();Tian.Widget=Tian.Class({div:null,title:null,baseZIndex:1000,os:null,initialize:function(){},draw:function(){this.div=document.createElement('div');this.div.id=Tian.createUniqueID('txWidgetID_');this.div.style.zIndex=(this.baseZIndex+parseInt(this.div.id.slice(11),10));if(this.title){this.div.title=this.title;}
return this.div;},destroy:function(){var parent=this.div.parentNode;if(parent&&parent.removeChild){parent.removeChild(this.div);}
this.div=null;this.os=null;},setOS:function(os){if(!this.os){this.os=os;}},getOS:function(){return this.os;},CLASS_NAME:"Tian.Widget"});Tian.Widget.Taskbar=Tian.Class(Tian.Widget,{draw:function(){Tian.Widget.prototype.draw.apply(this,arguments);if(this.div){this.div.className='txWidgetTaskbar txWidgetNoSelect';}
return this.div;},CLASS_NAME:"Tian.Widget.Taskbar"});(function($){if(!$||!($.JSON||Object.toJSON||window.JSON)){throw new Error("Tian needs to be loaded before jStorage!");}
var
_storage={},_storage_service={jStorage:"{}"},_storage_elm=null,_storage_size=0,json_encode=$.JSON.stringify||Object.toJSON||(window.JSON&&(JSON.encode||JSON.stringify)),json_decode=$.JSON.parse||(window.JSON&&(JSON.decode||JSON.parse))||function(str){return String(str).evalJSON();},_backend=false,_ttl_timeout,_XMLService={isXML:function(elm){var documentElement=(elm?elm.ownerDocument||elm:0).documentElement;return documentElement?documentElement.nodeName!=="HTML":false;},encode:function(xmlNode){if(!this.isXML(xmlNode)){return false;}
try{return new XMLSerializer().serializeToString(xmlNode);}catch(E1){try{return xmlNode.xml;}catch(E2){}}
return false;},decode:function(xmlString){var dom_parser=("DOMParser"in window&&(new DOMParser()).parseFromString)||(window.ActiveXObject&&function(_xmlString){var xml_doc=new ActiveXObject('Microsoft.XMLDOM');xml_doc.async='false';xml_doc.loadXML(_xmlString);return xml_doc;}),resultXML;if(!dom_parser){return false;}
resultXML=dom_parser.call("DOMParser"in window&&(new DOMParser())||window,xmlString,'text/xml');return this.isXML(resultXML)?resultXML:false;}};function _init(){var localStorageReallyWorks=false;if("localStorage"in window){try{window.localStorage.setItem('_tmptest','tmpval');localStorageReallyWorks=true;window.localStorage.removeItem('_tmptest');}catch(BogusQuotaExceededErrorOnIos5){}}
if(localStorageReallyWorks){try{if(window.localStorage){_storage_service=window.localStorage;_backend="localStorage";}}catch(E3){}}
else if("globalStorage"in window){try{if(window.globalStorage){_storage_service=window.globalStorage[window.location.hostname];_backend="globalStorage";}}catch(E4){}}
else{_storage_elm=document.createElement('link');if(_storage_elm.addBehavior){_storage_elm.style.behavior='url(#default#userData)';document.getElementsByTagName('head')[0].appendChild(_storage_elm);_storage_elm.load("jStorage");var data="{}";try{data=_storage_elm.getAttribute("jStorage");}catch(E5){}
_storage_service.jStorage=data;_backend="userDataBehavior";}else{_storage_elm=null;return;}}
_load_storage();_handleTTL();}
function _load_storage(){if(_storage_service.jStorage){try{_storage=json_decode(String(_storage_service.jStorage));}catch(E6){_storage_service.jStorage="{}";}}else{_storage_service.jStorage="{}";}
_storage_size=_storage_service.jStorage?String(_storage_service.jStorage).length:0;}
function _save(){try{_storage_service.jStorage=json_encode(_storage);if(_storage_elm){_storage_elm.setAttribute("jStorage",_storage_service.jStorage);_storage_elm.save("jStorage");}
_storage_size=_storage_service.jStorage?String(_storage_service.jStorage).length:0;}catch(E7){}}
function _checkKey(key){if(!key||(typeof key!="string"&&typeof key!="number")){throw new TypeError('Key name must be string or numeric');}
if(key=="__jstorage_meta"){throw new TypeError('Reserved key name');}
return true;}
function _handleTTL(){var curtime,i,TTL,nextExpire=Infinity,changed=false;clearTimeout(_ttl_timeout);if(!_storage.__jstorage_meta||typeof _storage.__jstorage_meta.TTL!="object"){return;}
curtime=+new Date();TTL=_storage.__jstorage_meta.TTL;for(i in TTL){if(TTL.hasOwnProperty(i)){if(TTL[i]<=curtime){delete TTL[i];delete _storage[i];changed=true;}else if(TTL[i]<nextExpire){nextExpire=TTL[i];}}}
if(nextExpire!=Infinity){_ttl_timeout=setTimeout(_handleTTL,nextExpire-curtime);}
if(changed){_save();}}
$.DB={version:"0.1.7.0",set:function(key,value,options){_checkKey(key);options=options||{};if(_XMLService.isXML(value)){value={_is_xml:true,xml:_XMLService.encode(value)};}else if(typeof value=="function"){value=null;}else if(value&&typeof value=="object"){value=json_decode(json_encode(value));}
_storage[key]=value;if(!isNaN(options.TTL)){this.setTTL(key,options.TTL);}else{_save();}
return value;},get:function(key,def){_checkKey(key);if(key in _storage){if(_storage[key]&&typeof _storage[key]=="object"&&_storage[key]._is_xml&&_storage[key]._is_xml){return _XMLService.decode(_storage[key].xml);}else{return _storage[key];}}
return typeof(def)=='undefined'?null:def;},deleteKey:function(key){_checkKey(key);if(key in _storage){delete _storage[key];if(_storage.__jstorage_meta&&typeof _storage.__jstorage_meta.TTL=="object"&&key in _storage.__jstorage_meta.TTL){delete _storage.__jstorage_meta.TTL[key];}
_save();return true;}
return false;},setTTL:function(key,ttl){var curtime=+new Date();_checkKey(key);ttl=Number(ttl)||0;if(key in _storage){if(!_storage.__jstorage_meta){_storage.__jstorage_meta={};}
if(!_storage.__jstorage_meta.TTL){_storage.__jstorage_meta.TTL={};}
if(ttl>0){_storage.__jstorage_meta.TTL[key]=curtime+ttl;}else{delete _storage.__jstorage_meta.TTL[key];}
_save();_handleTTL();return true;}
return false;},flush:function(){_storage={};_save();return true;},storageObj:function(){function F(){}
F.prototype=_storage;return new F();},index:function(){var index=[],i;for(i in _storage){if(_storage.hasOwnProperty(i)&&i!="__jstorage_meta"){index.push(i);}}
return index;},storageSize:function(){return _storage_size;},currentBackend:function(){return _backend;},storageAvailable:function(){return!!_backend;},reInit:function(){var new_storage_elm,data;if(_storage_elm&&_storage_elm.addBehavior){new_storage_elm=document.createElement('link');_storage_elm.parentNode.replaceChild(new_storage_elm,_storage_elm);_storage_elm=new_storage_elm;_storage_elm.style.behavior='url(#default#userData)';document.getElementsByTagName('head')[0].appendChild(_storage_elm);_storage_elm.load("jStorage");data="{}";try{data=_storage_elm.getAttribute("jStorage");}catch(E5){}
_storage_service.jStorage=data;_backend="userDataBehavior";}
_load_storage();}};_init();})(window.Tian);Tian.Function={bind:function(func,object){var args=Array.prototype.slice.apply(arguments,[2]);return function(){var newArgs=args.concat(Array.prototype.slice.apply(arguments,[0]));return func.apply(object,newArgs);};},bindAsEventListener:function(func,object){return function(event){return func.call(object,event||window.event);};},False:function(){return false;},True:function(){return true;},Void:function(){}};Tian.Event={observers:false,KEY_SPACE:32,KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_DELETE:46,element:function(event){return event.target||event.srcElement;},isSingleTouch:function(event){return event.touches&&event.touches.length==1;},isMultiTouch:function(event){return event.touches&&event.touches.length>1;},isLeftClick:function(event){return(((event.which)&&(event.which==1))||((event.button)&&(event.button==1)));},isRightClick:function(event){return(((event.which)&&(event.which==3))||((event.button)&&(event.button==2)));},stop:function(event,allowDefault){if(!allowDefault){if(event.preventDefault){event.preventDefault();}else{event.returnValue=false;}}
if(event.stopPropagation){event.stopPropagation();}else{event.cancelBubble=true;}},findElement:function(event,tagName){var element=Tian.Event.element(event);while(element.parentNode&&(!element.tagName||(element.tagName.toUpperCase()!=tagName.toUpperCase()))){element=element.parentNode;}
return element;},observe:function(elementParam,name,observer,useCapture){var element=Tian.getElement(elementParam);useCapture=useCapture||false;if(name=='keypress'&&(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||element.attachEvent)){name='keydown';}
if(!this.observers){this.observers={};}
if(!element._eventCacheID){var idPrefix="eventCacheID_";if(element.id){idPrefix=element.id+"_"+idPrefix;}
element._eventCacheID=Tian.createUniqueID(idPrefix);}
var cacheID=element._eventCacheID;if(!this.observers[cacheID]){this.observers[cacheID]=[];}
this.observers[cacheID].push({'element':element,'name':name,'observer':observer,'useCapture':useCapture});if(element.addEventListener){element.addEventListener(name,observer,useCapture);}else if(element.attachEvent){element.attachEvent('on'+name,observer);}},stopObservingElement:function(elementParam){var element=Tian.getElement(elementParam);var cacheID=element._eventCacheID;this._removeElementObservers(Tian.Event.observers[cacheID]);},_removeElementObservers:function(elementObservers){if(elementObservers){for(var i=elementObservers.length-1;i>=0;i--){var entry=elementObservers[i];var args=new Array(entry.element,entry.name,entry.observer,entry.useCapture);var removed=Tian.Event.stopObserving.apply(this,args);}}},stopObserving:function(elementParam,name,observer,useCapture){useCapture=useCapture||false;var element=Tian.getElement(elementParam);var cacheID=element._eventCacheID;if(name=='keypress'){if(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||element.detachEvent){name='keydown';}}
var foundEntry=false;var elementObservers=Tian.Event.observers[cacheID];if(elementObservers){var i=0;while(!foundEntry&&i<elementObservers.length){var cacheEntry=elementObservers[i];if((cacheEntry.name==name)&&(cacheEntry.observer==observer)&&(cacheEntry.useCapture==useCapture)){elementObservers.splice(i,1);if(elementObservers.length==0){delete Tian.Event.observers[cacheID];}
foundEntry=true;break;}
i++;}}
if(foundEntry){if(element.removeEventListener){element.removeEventListener(name,observer,useCapture);}else if(element&&element.detachEvent){element.detachEvent('on'+name,observer);}}
return foundEntry;},unloadCache:function(){if(Tian.Event&&Tian.Event.observers){for(var cacheID in Tian.Event.observers){var elementObservers=Tian.Event.observers[cacheID];Tian.Event._removeElementObservers.apply(this,[elementObservers]);}
Tian.Event.observers=false;}}};Tian.Event.observe(window,'unload',Tian.Event.unloadCache,false);Tian.Events=Tian.Class({BROWSER_EVENTS:["mouseover","mouseout","mousedown","mouseup","mousemove","click","dblclick","rightclick","dblrightclick","resize","focus","blur","touchstart","touchmove","touchend","keydown"],listeners:null,object:null,element:null,eventHandler:null,fallThrough:null,includeXY:false,extensions:null,extensionCount:null,clearMouseListener:null,initialize:function(object,element,fallThrough,options){Tian.extend(this,options);this.object=object;this.fallThrough=fallThrough;this.listeners={};this.extensions={};this.extensionCount={};if(element!=null){this.attachToElement(element);}},destroy:function(){for(var e in this.extensions){if(typeof this.extensions[e]!=="boolean"){this.extensions[e].destroy();}}
this.extensions=null;if(this.element){Tian.Event.stopObservingElement(this.element);if(this.element.hasScrollEvent){Tian.Event.stopObserving(window,"scroll",this.clearMouseListener);}}
this.element=null;this.listeners=null;this.object=null;this.fallThrough=null;this.eventHandler=null;},attachToElement:function(element){if(this.element){Tian.Event.stopObservingElement(this.element);}else{this.eventHandler=Tian.Function.bindAsEventListener(this.handleBrowserEvent,this);this.clearMouseListener=Tian.Function.bind(this.clearMouseCache,this);}
this.element=element;for(var i=0,len=this.BROWSER_EVENTS.length;i<len;i++){Tian.Event.observe(element,this.BROWSER_EVENTS[i],this.eventHandler);}
Tian.Event.observe(element,"dragstart",Tian.Event.stop);},on:function(object){for(var type in object){if(type!="scope"&&object.hasOwnProperty(type)){this.register(type,object.scope,object[type]);}}},register:function(type,obj,func,priority){if(type in Tian.Events&&!this.extensions[type]){this.extensions[type]=new Tian.Events[type](this);}
if(func!=null){if(obj==null){obj=this.object;}
var listeners=this.listeners[type];if(!listeners){listeners=[];this.listeners[type]=listeners;this.extensionCount[type]=0;}
var listener={obj:obj,func:func};if(priority){listeners.splice(this.extensionCount[type],0,listener);if(typeof priority==="object"&&priority.extension){this.extensionCount[type]++;}}else{listeners.push(listener);}}},registerPriority:function(type,obj,func){this.register(type,obj,func,true);},un:function(object){for(var type in object){if(type!="scope"&&object.hasOwnProperty(type)){this.unregister(type,object.scope,object[type]);}}},unregister:function(type,obj,func){if(obj==null){obj=this.object;}
var listeners=this.listeners[type];if(listeners!=null){for(var i=0,len=listeners.length;i<len;i++){if(listeners[i].obj==obj&&listeners[i].func==func){listeners.splice(i,1);break;}}}},remove:function(type){if(this.listeners[type]!=null){this.listeners[type]=[];}},triggerEvent:function(type,evt){var listeners=this.listeners[type];if(!listeners||listeners.length==0){return undefined;}
if(evt==null){evt={};}
evt.object=this.object;evt.element=this.element;if(!evt.type){evt.type=type;}
listeners=listeners.slice();var continueChain;for(var i=0,len=listeners.length;i<len;i++){var callback=listeners[i];continueChain=callback.func.apply(callback.obj,[evt]);if((continueChain!=undefined)&&(continueChain==false)){break;}}
if(!this.fallThrough){Tian.Event.stop(evt,true);}
return continueChain;},handleBrowserEvent:function(evt){var type=evt.type,listeners=this.listeners[type];if(!listeners||listeners.length==0){return;}
var touches=evt.touches;if(touches&&touches[0]){var x=0;var y=0;var num=touches.length;var touch;for(var i=0;i<num;++i){touch=touches[i];x+=touch.clientX;y+=touch.clientY;}
evt.clientX=x/num;evt.clientY=y/num;}
if(this.includeXY){evt.xy=this.getMousePosition(evt);}
this.triggerEvent(type,evt);},clearMouseCache:function(){this.element.scrolls=null;this.element.lefttop=null;var body=document.body;if(body&&!((body.scrollTop!=0||body.scrollLeft!=0)&&navigator.userAgent.match(/iPhone/i))){this.element.offsets=null;}},getMousePosition:function(evt){if(!this.includeXY){this.clearMouseCache();}else if(!this.element.hasScrollEvent){Tian.Event.observe(window,"scroll",this.clearMouseListener);this.element.hasScrollEvent=true;}
if(!this.element.scrolls){var viewportElement=Tian.getViewportElement();this.element.scrolls=[viewportElement.scrollLeft,viewportElement.scrollTop];}
if(!this.element.lefttop){this.element.lefttop=[(document.documentElement.clientLeft||0),(document.documentElement.clientTop||0)];}
if(!this.element.offsets){this.element.offsets=Tian.pagePosition(this.element);}
var xy={x:(evt.clientX+this.element.scrolls[0])-this.element.offsets[0]-this.element.lefttop[0],y:(evt.clientY+this.element.scrolls[1])-this.element.offsets[1]-this.element.lefttop[1]};return xy;},CLASS_NAME:"Tian.Events"});Tian.OS=Tian.Class({div:null,mainPanel:null,titleBar:null,taskbar:null,widgets:null,map:null,wm:null,dataHost:'',theme:'default',themeHost:'',imagePath:'',events:null,account:null,accInstance:null,socket:null,socketid:null,devices:null,initialize:function(datahost,themehost){var body=document.getElementsByTagName("body")[0]||document.documentElement;this.div=document.createElement('div');this.div.className='txOS';body.insertBefore(this.div,body.firstChild);if(typeof datahost=='string'&&datahost.length>0){if(datahost.charAt(datahost.length-1)=='/'){datahost=datahost.slice(0,datahost.length-1);}
this.dataHost=datahost;}
if(typeof themehost=='string'&&themehost.length>0){if(themehost.charAt(themehost.length-1)!='/'){themehost+='/';}
this.themeHost=themehost;}
if(typeof OpenLayers!='undefined'){OpenLayers.ProxyHost="/cgi-bin/proxy.cgi?url=";}},boot:function(){if(this.themeHost){Tian.requireCSS(this.themeHost+this.theme+'/style.css');this.setImagePath();}
this.events=new Tian.Events(this,null,true);this.mainPanel=new Tian.Widget.MainPanel();this.div.appendChild(this.mainPanel.draw());this.mainPanel.setOS(this);this.titleBar=new Tian.Widget.TitleBar();this.div.appendChild(this.titleBar.draw());this.titleBar.setOS(this);this.taskbar=new Tian.Widget.Taskbar();this.div.appendChild(this.taskbar.draw());this.taskbar.setOS(this);this.createWindowManager();if(typeof OpenLayers!=='undefined'){this.createMap();this.createDeviceLayer();}
if(typeof io!=='undefined'&&this.dataHost){this.createSocket();}
this.events.register('wedata',this,this.onWeData);this.events.register('signin',this,this.onSignIn);this.events.register('signout',this,this.onSignOut);this.events.register('devicecreate',this,this.onDeviceCreate);this.events.register('devicedelete',this,this.onDeviceDelete);this.events.register('deviceupdate',this,this.onDeviceUpdate);var acc=Tian.DB.get(Tian.md5(this.CLASS_NAME+'_account'));if(typeof acc==='object'){this.events.triggerEvent('signin',{account:acc,localdb:true});}},exit:function(){if(this.socket){this.socket.disconnect();this.socket=null;}
if(this.map){this.map.destroy();this.map=null;if(this.devices){this.devices.deviceDragger=null;this.devices=null;}}
this.wm.destroy();this.wm=null;this.titleBar.destroy();this.titleBar=null;this.taskbar.destroy();this.taskbar=null;this.mainPanel.destroy();this.mainPanel=null;this.events.destroy();this.events=null;},createWindowManager:function(){this.wm=new Tian.Winager({container:this.div,taskbar:this.taskbar.div,defaultX:50,defaultY:35,iconWidth:36,cacheXHR:true});},createMap:function(){this.map=new OpenLayers.Map(this.div,{theme:null,projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326"),units:"m",maxResolution:156543.0339,maxExtent:new OpenLayers.Bounds(-20037509,-20037508.34,20037508.34,20037508.34),layers:[new OpenLayers.Layer.OSM(OpenLayers.i18n('OSM_Mapnik'),["http://a.tile.openstreetmap.org/${z}/${x}/${y}.png","http://b.tile.openstreetmap.org/${z}/${x}/${y}.png","http://c.tile.openstreetmap.org/${z}/${x}/${y}.png"],{attribution:"Tiles @ <a target='_blank' href='http://www.openstreetmap.org/' >Open Street Map</a>"}),new OpenLayers.Layer.OSM(OpenLayers.i18n('OSM_Cycle'),["http://a.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png","http://b.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png","http://c.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png"],{attribution:"Tiles @ <a target='_blank' href='http://www.opencyclemap.org/' >Open Cycle Map</a>",numZoomLevels:17}),new OpenLayers.Layer.OSM(OpenLayers.i18n('OSM_Transport'),["http://a.tile2.opencyclemap.org/transport/${z}/${x}/${y}.png","http://b.tile2.opencyclemap.org/transport/${z}/${x}/${y}.png","http://c.tile2.opencyclemap.org/transport/${z}/${x}/${y}.png"],{attribution:"Tiles @ <a target='_blank' href='http://www.opencyclemap.org/' >Open Cycle Map</a>"}),new OpenLayers.Layer.OSM(OpenLayers.i18n('OSM_MapQuest'),["http://otile1.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png","http://otile2.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png","http://otile3.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png","http://otile4.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png"],{attribution:"Tiles @ <a target='_blank' href='http://www.mapquest.com/' >MapQuest Open</a>"})],controls:[new OpenLayers.Control.ArgParser(),new OpenLayers.Control.TouchNavigation(),new OpenLayers.Control.Navigation(),new OpenLayers.Control.KeyboardDefaults(),new OpenLayers.Control.PanZoomBar(),new OpenLayers.Control.Attribution(),new OpenLayers.Control.ScaleLine({maxWidth:150,geodesic:true}),new OpenLayers.Control.MousePosition({numDigits:6,displayProjection:new OpenLayers.Projection("EPSG:4326")}),new OpenLayers.Control.LoadingPanel(),new OpenLayers.Control.WeOverviewMap()]});var maxExtent=this.map.getMaxExtent();var centerLon=Tian.DB.get(Tian.md5(this.CLASS_NAME+'_mapcenterlon'));var centerLat=Tian.DB.get(Tian.md5(this.CLASS_NAME+'_mapcenterlat'));var zoom=Tian.DB.get(Tian.md5(this.CLASS_NAME+'_mapzoom'));if(centerLon!=null&&centerLat!=null&&zoom!=null){this.map.setCenter(new OpenLayers.LonLat(centerLon,centerLat).transform(this.map.displayProjection,this.map.getProjectionObject()),zoom);}else{this.map.setCenter(maxExtent.getCenterLonLat(),this.map.getZoomForExtent(maxExtent)+1);}
this.map.events.register('moveend',this,this.onMapMoveEnd);this.map.events.register('zoomend',this,this.onMapZoomEnd);},createDeviceLayer:function(){if(!this.map)return;this.devices=new OpenLayers.Layer.Vector(Tian.i18n('txDevice'),{alwaysInRange:true});this.devices.deviceDragger=new OpenLayers.Control.DragFeature(this.devices,{autoActivate:true,onStart:Tian.Function.bind(this.onDeviceDragDown,this),onDrag:Tian.Function.bind(this.onDeviceDrag,this),onUp:Tian.Function.bind(this.onDeviceDragUp,this),onComplete:Tian.Function.bind(this.onDeviceDragDone,this),upFeature:function(pixel){this.onUp(this.feature,pixel);if(!this.over){this.handlers.drag.deactivate();}}});this.devices.events.register('visibilitychanged',this,this.onDeviceLayerVC);this.map.addLayer(this.devices);this.map.addControl(this.devices.deviceDragger);},createSocket:function(){this.socket=io.connect(this.dataHost,{'force new connection':true});if(this.socket){this.socket.on('connect',Tian.Function.bind(this.onSocketConnect,this));this.socket.on('disconnect',Tian.Function.bind(this.onSocketDisconnect,this));this.socket.on('message',Tian.Function.bind(this.onSocketMessage,this));this.socket.on('wedata',Tian.Function.bind(this.onSocketWeData,this));}},onMapMoveEnd:function(evt){var center=this.map.getCenter().transform(this.map.getProjectionObject(),this.map.displayProjection);Tian.DB.set(Tian.md5(this.CLASS_NAME+'_mapcenterlon'),center.lon);Tian.DB.set(Tian.md5(this.CLASS_NAME+'_mapcenterlat'),center.lat);},onMapZoomEnd:function(evt){Tian.DB.set(Tian.md5(this.CLASS_NAME+'_mapzoom'),this.map.getZoom());var sn,device;if(this.devices&&this.account&&this.account.weDevices){for(sn in this.account.weDevices){device=this.account.weDevices[sn];if(device instanceof Tian.Device){device.feature.geometry.calculateBounds();device.feature.layer.drawFeature(device.feature);}}}},onDeviceLayerVC:function(evt){if(this.devices.getVisibility()){this.devices.deviceDragger.activate();}else{this.devices.deviceDragger.deactivate();}},onSocketConnect:function(){if(!this.socketid){this.socketid=this.socket.socket.sessionid;}
this.socket.emit('subscribe',this.socketid);this.notify('OS online');this.events.triggerEvent('socketconnect');},onSocketDisconnect:function(){this.notify('OS offline');this.events.triggerEvent('socketdisconnect');},onSocketMessage:function(msg){this.notify('Message: '+msg);this.events.triggerEvent('socketmessage',{message:msg});},onSocketWeData:function(data){this.events.triggerEvent('socketwedata',{wedata:data});},onWeData:function(event){if(this.socket&&event.wedata){this.socket.emit('wedata',event.wedata);}},onSignIn:function(event){if(!event.account||!event.account.user){return;}
this.account=event.account;if(!event.localdb){Tian.DB.set(Tian.md5(this.CLASS_NAME+'_account'),this.account);}
this.accInstance={weDevices:{},weApps:{},weLayers:{},weFeatures:{}};if(this.account.user){this.titleBar.setAccount(this.account.user);}
var i,len,device,options,weDevice;if(Tian.Array.isArray(this.account.devices)){for(i=0,len=this.account.devices.length;i<len;i++){device=this.account.devices[i];options={};if(this.devices&&device&&device.sn&&typeof device.opts==='object'){Tian.extend(options,device.opts);options.os=this;options.id=device.sn;options.key=(device.key||'');weDevice=new Tian.Device(options);this.devices.addFeatures([weDevice.feature]);this.accInstance.weDevices[device.sn]=weDevice;}}}
var app,weApp;if(Tian.Array.isArray(this.account.apps)){for(i=0,len=this.account.apps.length;i<len;i++){app=this.account.apps[i];if(app&&app.name&&typeof app.opts==='object'){weApp=new Tian.App(app.opts);this.mainPanel.addApp(weApp);this.accInstance.weApps[app.name]=weApp;}}}},onSignOut:function(event){this.titleBar.setAccount(Tian.i18n('txTitleBarAnonymous'));var key;for(key in this.accInstance.weDevices){if(this.accInstance.weDevices[key]instanceof Tian.Device){this.accInstance.weDevices[key].destroy();delete this.accInstance.weDevices[key];}}
for(key in this.accInstance.weApps){if(this.accInstance.weApps[key]instanceof Tian.App){this.mainPanel.delApp(this.accInstance.weApps[key]);this.accInstance.weApps[key].destroy();delete this.accInstance.weApps[key];}}
this.account=null;this.accInstance=null;Tian.DB.deleteKey(Tian.md5(this.CLASS_NAME+'_account'));},onDeviceCreate:function(event){if(!this.account||!event.device||!event.device.sn){return;}
var device=event.device;this.account.devices.push(device);Tian.DB.set(Tian.md5(this.CLASS_NAME+'_account'),this.account);if(this.devices){var options={};if(typeof device.opts==='object'){Tian.extend(options,device.opts);}
options.os=this;options.id=device.sn;options.key=(device.key||'');var deviceApp=new Tian.Device(options);this.devices.addFeatures([deviceApp.feature]);this.accInstance.weDevices[device.sn]=deviceApp;var extent=this.devices.getDataExtent();if(extent){this.map.zoomToExtent(extent);}}},onDeviceDelete:function(event){if(!this.account||!event.device||!event.device.sn){return;}
var sn=event.device.sn;var i,len;for(i=0,len=this.account.devices.length;i<len;i++){if(this.account.devices[i].sn===sn){this.account.devices.splice(i,1);break;}}
Tian.DB.set(Tian.md5(this.CLASS_NAME+'_account'),this.account);if(this.accInstance.weDevices[sn]instanceof Tian.Device){this.accInstance.weDevices[sn].destroy();delete this.accInstance.weDevices[sn];}},onDeviceUpdate:function(event){if(!this.account||!event.device||!event.device.sn){return;}
var device=event.device;var i,len;for(i=0,len=this.account.devices.length;i<len;i++){if(this.account.devices[i].sn===device.sn){if(device.title){this.account.devices[i].opts.title=device.title;}
if(device.icon){this.account.devices[i].opts.icon=device.icon;}
if(device.alarm){this.account.devices[i].opts.alarm=device.alarm;}
if(Tian.Array.isArray(device.lonlat)&&device.lonlat.length===2){this.account.devices[i].opts.lonlat[0]=device.lonlat[0];this.account.devices[i].opts.lonlat[1]=device.lonlat[1];}
break;}}
Tian.DB.set(Tian.md5(this.CLASS_NAME+'_account'),this.account);if(this.accInstance.weDevices[device.sn]instanceof Tian.Device){if(device.title){this.accInstance.weDevices[device.sn].setTitle(device.title);}
if(device.icon){this.accInstance.weDevices[device.sn].setIcon(device.icon);}
if(device.alarm){this.accInstance.weDevices[device.sn].setAlarm(device.alarm);}
if(Tian.Array.isArray(device.lonlat)&&device.lonlat.length===2){this.accInstance.weDevices[device.sn].setPosition(device.lonlat);}}},onDeviceDragDown:function(feature,px){if(feature&&feature.attributes){feature.attributes.dragged=false;}},onDeviceDrag:function(feature,px){if(feature&&feature.attributes){feature.attributes.dragged=true;if(feature.style.graphicWidth!==48){feature.style.graphicWidth=48;feature.style.graphicHeight=48;feature.layer&&feature.layer.drawFeature(feature);}}},onDeviceDragUp:function(feature,px){if(!feature||!feature.attributes){return;}
if(!feature.attributes.dragged&&feature.attributes.device){feature.attributes.device.onSelect();}},onDeviceDragDone:function(feature,px){if(feature&&feature.attributes&&feature.attributes.device){if(feature.style.graphicWidth!==32){feature.style.graphicWidth=32;feature.style.graphicHeight=32;feature.geometry.calculateBounds();feature.layer&&feature.layer.drawFeature(feature);}
var point=feature.geometry.getCentroid();if(point){point.transform(this.map.getProjectionObject(),this.map.displayProjection);this.events.triggerEvent('devicedragged',{device:{sn:feature.attributes.device.id,lonlat:[Tian.Number.limitFixDigs(point.x,6),Tian.Number.limitFixDigs(point.y,6)]}});}}},setImagePath:function(path){if(path){this.imagePath=path;}else{this.imagePath=this.themeHost+this.theme+'/img/';}
if(typeof OpenLayers!=='undefined'){OpenLayers.ImgPath=this.imagePath;}},getImagePath:function(){if(!this.imagePath){this.setImagePath();}
return this.imagePath;},changeTheme:function(theme){var scripturl,newurl,oldurl;if((theme)&&(theme!=this.theme)){newurl=this.themeHost+theme+'/style.css';oldurl=this.themeHost+this.theme+'/style.css';Tian.replaceCSS(oldurl,newurl);this.theme=theme;this.setImagePath();var panZoomBars=this.map.getControlsByClass('OpenLayers.Control.PanZoomBar');if(panZoomBars&&panZoomBars.length>0){panZoomBars[0].redraw();}}},notify:function(str){if(this.titleBar){this.titleBar.notify(str);}},getMap:function(){return this.map;},getWindowManager:function(){return this.wm;},getEvents:function(){return this.events;},getMainPanel:function(){return this.mainPanel;},getAccount:function(){return this.account;},getDeviceLayer:function(){return this.devices;},getHost:function(){return this.dataHost;},CLASS_NAME:"Tian.OS"});Tian.Lang.add('en','txApp','Tian Embeded Application');Tian.Lang.add('en','txAppConfirm','Press [OK] to close, or [Cancel] to minimize the window.');Tian.Lang.add('zh-CN','txApp','');Tian.Lang.add('zh-CN','txAppConfirm','');Tian.App=Tian.Class({os:null,div:null,childTitle:null,childIcon:null,title:'',icon:'',page:'',window:null,width:450,height:250,theApp:null,initialize:function(options){Tian.extend(this,options);if(this.title&&typeof this.title[Tian.Lang.getCode()]==='string'){this.title=this.title[Tian.Lang.getCode()];}else{this.title=Tian.i18n('txApp');}},destroy:function(){if(this.window){this.window.close();this.window=null;}
Tian.Event.stopObservingElement(this.div);if(this.div.parentNode){this.div.parentNode.removeChild(this.div);}
this.div=null;this.childIcon=null;this.childTitle=null;this.os=null;},draw:function(){if(!this.icon&&this.os){this.icon=this.os.getImagePath()+'default_app_icon.png';}
if(this.div==null){this.div=document.createElement('div');}
this.div.className='txApp';if(this.icon){this.childIcon=document.createElement('img');this.childIcon.src=this.icon;this.div.appendChild(this.childIcon);}
if(this.title){this.childTitle=document.createElement('p');this.childTitle.innerHTML=this.title;this.div.appendChild(this.childTitle);}
Tian.Event.observe(this.div,"click",Tian.Function.bindAsEventListener(this.onOpen,this));return this.div;},setOS:function(os){if(!this.os){this.os=os;}},getOS:function(){return this.os;},onOpen:function(evt){if(evt){Tian.Event.stop(evt);}
if(this.window){this.window.select();return;}
if(!this.os){return;}
var wm=this.os.getWindowManager();var ww=null,wh=null,wx=null,wy=null;ww=Tian.DB.get(Tian.md5(this.title+'_ww'));wh=Tian.DB.get(Tian.md5(this.title+'_wh'));wx=Tian.DB.get(Tian.md5(this.title+'_wx'));wy=Tian.DB.get(Tian.md5(this.title+'_wy'));this.window=wm.createWindow({title:this.title,state:'window',width:ww?ww:this.width,height:wh?wh:this.height,x:wx?wx:null,y:wy?wy:null,iconImageURL:this.icon,closeConfirm:Tian.i18n('txAppConfirm')});this.window.onclose=Tian.Function.bind(this.onWinClose,this);this.window.onmove=Tian.Function.bind(this.onWinMove,this);this.window.onresize=Tian.Function.bind(this.onWinResize,this);if(this.page){this.window.loadUrlX(this.page,Tian.Function.bind(this.onWinLoad,this));}},setTitle:function(title){if(title&&title!==this.title){this.title=title;this.childTitle.innerHTML=title;this.window&&this.window.setTitle(title);}},getTitle:function(){return this.title;},setIcon:function(icon){if(icon&&icon!==this.icon){this.icon=icon;this.childIcon.src=icon;this.window&&this.window.setIconImage(icon);}},onWinLoad:function(window){if(!window){return;}
var theFrame=window.getElement('theFrame');if(theFrame&&theFrame.contentWindow&&typeof theFrame.contentWindow.tianMain==='function'){this.theApp=theFrame.contentWindow.tianMain.call(theFrame.contentWindow,{app:this,win:window});}},onWinClose:function(){this.window=null;this.theApp=null;},onWinMove:function(x,y){Tian.DB.set(Tian.md5(this.title+'_wx'),x);Tian.DB.set(Tian.md5(this.title+'_wy'),y);},onWinResize:function(w,h,a){switch(a){case'resize':Tian.DB.set(Tian.md5(this.title+'_ww'),w);Tian.DB.set(Tian.md5(this.title+'_wh'),h);break;case'maximize':break;case'restore':break;}},CLASS_NAME:"Tian.App"});Tian.Window=Tian.Class({id:'',wm:null,w:0,h:0,x:0,y:0,userW:0,userH:0,userX:0,userY:0,movable:false,alwaysOnTop:false,resizing:false,moving:false,titleText:'',title:null,titleSpan:null,iconImageURL:'',state:'window',prvState:'',win:null,content:null,taskbarIcon:null,taskbarIconSpan:null,taskbarIconImage:null,components:null,currentUrl:'',closeConfirm:'',afterLoad:null,onunload:null,onselect:null,onresize:null,onmove:null,oniconize:null,ondeselect:null,onclose:null,onhttperror:null,initialize:function(opts,manager){this.id=opts.id||Tian.createUniqueID();this.wm=manager;this.w=(typeof opts.width=='number'?opts.width:manager.opts.defaultWidth);this.h=(typeof opts.height=='number'?opts.height:manager.opts.defaultHeight);this.x=(typeof opts.x=='number'?opts.x:manager.opts.defaultX);this.y=(typeof opts.y=='number'?opts.y:manager.opts.defaultY);if(opts.centered){this.x=(manager.getContainerWidth()-this.w)/2;this.y=(manager.getContainerHeight()-this.h)/2;if(this.x<0){this.x=0;}
if(this.y<0){this.y=0;}}
this.userW=this.w;this.userH=this.h;this.movable=(typeof opts.movable=='undefined'?manager.opts.movable:opts.movable);this.alwaysOnTop=opts.alwaysOnTop||false;this.titleText=opts.title||'';this.iconImageURL=opts.iconImageURL||'';this.afterLoad=opts.afterLoad||manager.opts.afterLoad;this.components={titlebar:null,window:null,content:null,maximizer:null,iconizer:null,close:null,icon:null,loading:null,iconImage:null};},destroy:function(){},attachEvents:function(){if(this.components.iconImage){Tian.Event.observe(this.components.iconImage,'mousedown',Tian.Function.bind(this.onIconMouseDown,this));Tian.Event.observe(this.components.iconImage,'touchstart',Tian.Function.bind(this.onIconMouseDown,this));Tian.Event.observe(this.components.iconImage,'mousemove',Tian.Function.bind(this.onIconMouseMove,this));Tian.Event.observe(this.components.iconImage,'touchmove',Tian.Function.bind(this.onIconMouseMove,this));Tian.Event.observe(this.components.iconImage,'mouseup',Tian.Function.bind(this.onIconMouseUp,this));Tian.Event.observe(this.components.iconImage,'mouseout',Tian.Function.bind(this.onIconMouseUp,this));Tian.Event.observe(this.components.iconImage,'touchend',Tian.Function.bind(this.onIconMouseUp,this));}
if(this.titleSpan){Tian.Event.observe(this.titleSpan,'mousedown',Tian.Function.bind(this.onTitleMouseDown,this));Tian.Event.observe(this.titleSpan,'touchstart',Tian.Function.bind(this.onTitleMouseDown,this));Tian.Event.observe(this.titleSpan,'mousemove',Tian.Function.bind(this.onTitleMouseMove,this));Tian.Event.observe(this.titleSpan,'touchmove',Tian.Function.bind(this.onTitleMouseMove,this));Tian.Event.observe(this.titleSpan,'mouseup',Tian.Function.bind(this.onTitleMouseUp,this));Tian.Event.observe(this.titleSpan,'mouseout',Tian.Function.bind(this.onTitleMouseUp,this));Tian.Event.observe(this.titleSpan,'touchend',Tian.Function.bind(this.onTitleMouseUp,this));}
if(this.components.close){Tian.Event.observe(this.components.close,'click',Tian.Function.bind(this.onCloseClick,this));}
if(this.components.maximizer){Tian.Event.observe(this.components.maximizer,'click',Tian.Function.bind(this.onMaxClick,this));}
if(this.components.iconizer){Tian.Event.observe(this.components.iconizer,'click',Tian.Function.bind(this.onMinClick,this));}
if(this.win){Tian.Event.observe(this.win,'click',Tian.Function.bind(this.onWinClick,this));}},detachEvents:function(){if(this.components.iconImage){Tian.Event.stopObservingElement(this.components.iconImage);}
if(this.titleSpan){Tian.Event.stopObservingElement(this.titleSpan);}
if(this.components.close){Tian.Event.stopObservingElement(this.components.close);}
if(this.components.maximizer){Tian.Event.stopObservingElement(this.components.maximizer);}
if(this.components.iconizer){Tian.Event.stopObservingElement(this.components.iconizer);}
if(this.win){Tian.Event.stopObservingElement(this.win);}},onTitleMouseDown:function(e){Tian.Event.stop(e);this.select();if(!this.movable){return;}
this.moving=true;if(!e){e=window.event;}
var xy=this.wm.getEventXY(e,this.titleSpan);this.wm.mouse.click.x=xy.x-this.x;this.wm.mouse.click.y=xy.y-this.y;},onTitleMouseMove:function(e){Tian.Event.stop(e);if(!this.moving){return;}
if(!e){e=window.event;}
this.state='window';var xy=this.wm.getEventXY(e,this.titleSpan);this.wm.mouse.cur.x=xy.x;this.wm.mouse.cur.y=xy.y;var y=(this.wm.mouse.cur.y-this.wm.mouse.click.y);var x=(this.wm.mouse.cur.x-this.wm.mouse.click.x);if(this.wm.opts.containerBoundaries>0){var minx=-1*(this.getWidth()-this.wm.opts.containerBoundaries);var maxx=this.getContainerWidth()-this.wm.opts.containerBoundaries;var maxy=this.getContainerHeight()-this.wm.opts.containerBoundaries;if(x<minx)x=minx;if(x>maxx)x=maxx;if(y>maxy)y=maxy;}
if(this.wm.opts.containerBoundaries>-1){if(y<0)y=0;}
this.win.style.left=x+'px';this.win.style.top=y+'px';if(typeof this.onmove==='function'){this.onmove(x,y);}},onTitleMouseUp:function(e){Tian.Event.stop(e);this.moving=false;if(this.state==='window'){this.w=parseInt(this.win.style.width,10);this.h=parseInt(this.win.style.height,10);this.x=parseInt(this.win.style.left,10);this.y=parseInt(this.win.style.top,10);this.userW=this.w;this.userH=this.h;this.userX=this.x
this.userY=this.y}},onIconMouseDown:function(e){Tian.Event.stop(e);this.select();this.resizing=true;if(!e){e=window.event;}
var xy=this.wm.getEventXY(e,this.components.iconImage);this.wm.mouse.click.rx=xy.x;this.wm.mouse.click.ry=xy.y;this.wm.mouse.click.x=xy.x-this.x;this.wm.mouse.click.y=xy.y-this.y;},onIconMouseMove:function(e){Tian.Event.stop(e);if(!this.resizing){return;}
this.state='window';if(!e){e=window.event;}
var xy=this.wm.getEventXY(e,this.components.iconImage);this.wm.mouse.cur.x=xy.x;this.wm.mouse.cur.y=xy.y;var y=(this.wm.mouse.cur.y-this.wm.mouse.click.y);var x=(this.wm.mouse.cur.x-this.wm.mouse.click.x);if(this.wm.opts.containerBoundaries>0){var minx=-1*(this.getWidth()-this.wm.opts.containerBoundaries);var maxx=this.getContainerWidth()-this.wm.opts.containerBoundaries;var maxy=this.getContainerHeight()-this.wm.opts.containerBoundaries;if(x<minx)x=minx;if(x>maxx)x=maxx;if(y>maxy)y=maxy;}
if(this.wm.opts.containerBoundaries>-1){if(y<0)y=0;}
this.win.style.top=y+'px';this.win.style.left=x+'px';var h=(this.h+(this.wm.mouse.click.ry-this.wm.mouse.cur.y));var w=(this.w+(this.wm.mouse.click.rx-this.wm.mouse.cur.x));if(w<90)w=90;if(h<50)h=50;this._setSize(w,h,true,'resize');},onIconMouseUp:function(e){Tian.Event.stop(e);this.resizing=false;if(this.state==='window'){this.w=parseInt(this.win.style.width,10);this.h=parseInt(this.win.style.height,10);this.x=parseInt(this.win.style.left,10);this.y=parseInt(this.win.style.top,10);this.userW=this.w;this.userH=this.h;this.userX=this.x
this.userY=this.y}},onCloseClick:function(e){Tian.Event.stop(e);this.select();if(this.closeConfirm){if(window.confirm(this.closeConfirm)){this.close();}else{this._iconify();}}else{this.close();}},onMaxClick:function(e){Tian.Event.stop(e);this.select();this._maximize();},onMinClick:function(e){Tian.Event.stop(e);this.select();this._iconify();},onWinClick:function(e){this.select();},getElement:function(eid,o){if(!o)o=this.content;for(var a=0;a<o.childNodes.length;a++){if(o.childNodes[a].getAttribute&&o.childNodes[a].getAttribute("data-wid")==eid){return o.childNodes[a];}
var t=this.getElement(eid,o.childNodes[a]);if(t)return t;}
return null;},setState:function(state){switch(state){case'maximized':if(this.state=='maximized'){return;}
this._maximize();return;case'window':if(this.state=='maximized'){this._maximize();return;}
this.state='window';this.select();return;case'icon':this._iconify();return;case'hidden':this.hide();return;}},setSize:function(w,h){this.state='window';this._setSize(w,h,false,'resize');this.userW=w;this.userH=h;},autoSize:function(){this.win.style.height=0+'px';this.win.style.width=0+'px';this.content.style.height=0+'px';this.content.style.width=0+'px';var w=this.content.scrollWidth+30;var h=this.content.scrollHeight+70;this.setSize(w,h);this.state='window';},setPosition:function(x,y){this._setPosition(x,y);if(typeof this.onmove==='function')this.onmove(x,y);},moveToCenter:function(){var x,y;x=(this.getContainerWidth()-this.w)/2;y=(this.getContainerHeight()-this.h)/2;if(y<0)y=0;this.setPosition(x,y);},close:function(){this.wm._destroyWindow(this);},select:function(){this.wm._selectWindow(this);},hide:function(){this.prvState=this.state;this.state='hidden';this.win.style.visibility='hidden';this.win.style.display='none';},attachTo:function(el){el=el||this.wm.opts.container;el.appendChild(this.win);},setContent:function(html,element){var afterLoad=null;if(!element){element=this.content;afterLoad=this.afterLoad;}
element.innerHTML=html.replace(/<script.*?>[\s\S]*?<\/.*?script>/gi,"");if(typeof afterLoad==='function')afterLoad(this);},loadUrl:function(url,onload,onerror){this.showLoading();var req=false;if(window.XMLHttpRequest&&!(window.ActiveXObject)){try{req=new XMLHttpRequest();}catch(e){req=false;}}else if(window.ActiveXObject){try{req=new ActiveXObject("Msxml2.XMLHTTP");}catch(e){try{req=new ActiveXObject("Microsoft.XMLHTTP");}catch(e){req=false;}}}
if(!req){window.alert("AJAX not supported by this browser");if(typeof onerror==='function')onerror(this);return false;}
req.onreadystatechange=(function(w){return function(){if(req.readyState==4){w.showLoading(false);switch(req.status){case 200:w.currentUrl=url;w.setContent(req.responseText);if(typeof onload==='function')onload(w);break;default:if(typeof onerror==='function')onerror(w);if(typeof w.onhttperror==='function'){w.onhttperror(req,url);return;}
if(typeof w.wm.opts.httpErrorHandler==='function'){w.wm.opts.httpErrorHandler(req,url,w);return;}
window.alert("HTTP Error: "+req.status+"\n"+url);}}}})(this);if(!this.wm.opts.cacheXHR){var ts=(new Date).getTime();var ret=url.replace(/(\?|&)_=.*?(&|$)/,"$1_="+ts+"$2");url=ret+((ret===url)?((/\?/).test(url)?"&":"?")+"_="+ts:"");}
req.open("GET",url,true);req.send("");},loadUrlX:function(url,onload){this.showLoading();this.content.innerHTML='';var frame=document.createElement('iframe');frame.className=this.wm.opts.classFrame;frame.setAttribute('data-wid','theFrame');if(!this.wm.opts.cacheXHR){var now=new Date;var ts=now.getTime();var ret=url.replace(/(\?|&)_=.*?(&|$)/,"$1_="+ts+"$2");url=ret+((ret===url)?((/\?/).test(url)?"&":"?")+"_="+ts:"");}
frame.src=url;Tian.Event.observe(frame,'load',(function(w,fm){return function(){w.currentUrl=url;w.showLoading(false);if(typeof onload==='function')onload(w);Tian.Event.stopObservingElement(fm);}})(this,frame));this.content.appendChild(frame);},showLoading:function(show){if(typeof show=='undefined'||show){this.loading.style.display='';this.loading.style.visibility='visible';}else{this.loading.style.visibility='hidden';this.loading.style.display='none';}},setTitle:function(title){if(title){this.titleText=title;if(this.titleSpan)this.titleSpan.innerHTML=title;if(this.taskbarIcon)this.taskbarIcon.setAttribute('title',title);if(this.taskbarIconSpan)this.taskbarIconSpan.innerHTML=title;}},setIconImage:function(iconUrl){if(iconUrl&&iconUrl!==this.iconImageURL){this.iconImageURL=iconUrl;if(this.components.iconImage)this.components.iconImage.src=iconUrl;if(this.taskbarIconImage)this.taskbarIconImage.src=iconUrl;}},setMovable:function(v){this.movable=v;},setAlwaysOnTop:function(v){if(v)this.select();this.alwaysOnTop=v;},isMovable:function(){return this.movable;},isAlwaysOnTop:function(){return this.alwaysOnTop;},isSelected:function(){return(this===this.getManager().getSelectedWindow());},getManager:function(){return this.wm;},getComponent:function(elem){return this.components[elem];},getWidth:function(){return this.w;},getHeight:function(){return this.h;},getX:function(){return this.x;},getY:function(){return this.y;},getContentWidth:function(){return parseInt(this.content.style.width);},getContentHeight:function(){return parseInt(this.content.style.height);},getId:function(){return this.id;},getTitle:function(){return this.titleText;},getCurrentUrl:function(full){return((this.wm.opts.cacheXHR||full)?this.currentUrl:this.currentUrl.replace(/(\?|&)_=.*/,''));},getState:function(){return this.state;},getContainer:function(){return this.win.parentNode;},getContainerWidth:function(){var c=this.getContainer();if(c===document.body){return this.wm.getBodySize().width;}
return c.clientWidth;},getContainerHeight:function(){var c=this.getContainer();if(c===document.body){return this.wm.getBodySize().height;}
return c.clientHeight;},_setPosition:function(x,y){this.state='window';this.win.style.left=x+'px';this.win.style.top=y+'px'
this.x=this.userX=x;this.y=this.userY=y;},_maximize:function(){if(this.state!='maximized'){var Dw=this.win.offsetWidth-parseInt(this.win.style.width);var Dh=this.win.offsetHeight-parseInt(this.win.style.height);this.win.style.top=0+'px';this.win.style.left=0+'px';this.x=this.y=1;this.state='maximized';var w=this.getContainerWidth()-Dw;var h=this.getContainerHeight()-Dh;this._setSize(w,h,false,'maximize');}else{this.state='window';this._setSize(this.userW,this.userH,false,'restore');this._setPosition(this.userX,this.userY);}},_setSize:function(w,h,isResize,action){this.win.style.height=h+'px';this.win.style.width=w+'px';var contw=w-(this.content.offsetWidth-parseInt(this.content.style.width));var conth=h-(this.content.offsetHeight-parseInt(this.content.style.height))-this.content.offsetTop;this.content.style.height=conth+'px';this.content.style.width=contw+'px';if(!isResize){this.w=w;this.h=h;}
if(action&&typeof this.onresize==='function')this.onresize(w,h,action);},_iconify:function(){if(!this.wm.opts.taskbar||this.state=='icon')return;if(!this.taskbarIcon){this._createTaskbarIcon();}
this.taskbarIcon.className=this.wm.opts.classIcon;if(this.wm.selectedWindow==this){this.wm.selectedWindow=null;}
this.hide();this.state='icon';var fw=this.wm._getFirstVisibleWindow();if(fw)fw.select();if(typeof this.oniconize==='function'){this.oniconize();}},_createTaskbarIcon:function(){if(!this.wm.opts.taskbar)return;this.taskbarIcon=document.createElement('div');this.taskbarIcon.className=this.wm.opts.classIcon;this.taskbarIcon.setAttribute('title',this.titleText);this.taskbarIcon.style.width=this.wm.opts.iconWidth+'px';this.taskbarIconImage=document.createElement('img');this.taskbarIconImage.src=this.iconImageURL;this.taskbarIconImage.setAttribute('title',this.titleText);this.taskbarIcon.appendChild(this.taskbarIconImage);this.taskbarIconSpan=document.createElement('span');this.taskbarIconSpan.innerHTML=this.titleText;this.taskbarIcon.appendChild(this.taskbarIconSpan);this.wm.opts.taskbar.appendChild(this.taskbarIcon);this.components.icon=this.taskbarIcon;if(this.wm.opts.resizeIcons)this.wm._resizeIcons();Tian.Event.observe(this.taskbarIcon,'click',Tian.Function.bind(this.onTaskbarIconClick,this));Tian.Event.observe(this.taskbarIcon,'dblclick',Tian.Function.bind(this.onTaskbarIconDoubleClick,this));},_removeTaskbarIcon:function(){Tian.Event.stopObservingElement(this.taskbarIcon);this.taskbarIcon.parentNode.removeChild(this.taskbarIcon);this.taskbarIcon=null;if(this.wm.opts.resizeIcons)this.wm._resizeIcons();},onTaskbarIconClick:function(e){Tian.Event.stop(e);if(this.isSelected()){this._iconify();}else{this.select();}},onTaskbarIconDoubleClick:function(e){Tian.Event.stop(e);this.moveToCenter();},_unload:function(){if(typeof this.onunload==='function'){if(!this.onunload()){return false;}}
this.detachEvents();this.onunload=null;this.onselect=null;this.onresize=null;this.onmove=null;this.oniconize=null;this.ondeselect=null;this.onhttperror=null;return true;},CLASS_NAME:"Tian.Window"});Tian.Lang.add('en','txDevice','Tian Certified Device');Tian.Lang.add('en','txDeviceAlarm','reports ALARM');Tian.Lang.add('en','txDeviceConfirm','Press [OK] to close, or [Cancel] to minimize the window.');Tian.Lang.add('zh-CN','txDevice','');Tian.Lang.add('zh-CN','txDeviceAlarm','');Tian.Lang.add('zh-CN','txDeviceConfirm','');Tian.Device=Tian.Class({id:'',key:'',os:null,lonlat:null,host:'',icon:'',title:'',angle:0,page:'',alarm:'',width:540,height:300,feature:null,events:null,window:null,theApp:null,alarmTimer:null,alarmInterval:618,alarmSound:null,socket:null,lastDeviceData:null,initialize:function(options){Tian.extend(this,options);if(!this.id){this.id=Tian.createUniqueID('txDevice_');}
if(!this.key){this.key=this.id;}
if(!this.title){this.title=Tian.i18n('txDevice');}
if(!Tian.Array.isArray(this.lonlat)||this.lonlat.length!==2){this.lonlat=[116.391499,39.903177];}
if(!this.icon&&this.os){this.icon=this.os.getImagePath()+'default_device_icon.png';}
if(!this.alarm&&this.os){this.alarm=this.os.getImagePath()+'default_device_alarm.mp3';}
if(typeof OpenLayers!=='undefined'){var point=new OpenLayers.Geometry.Point(this.lonlat[0],this.lonlat[1]);if(this.os!=null&&this.os.getMap()!=null){point.transform(this.os.getMap().displayProjection,this.os.getMap().getProjectionObject());}
var self=this;this.feature=new OpenLayers.Feature.Vector(point,{device:self,dragged:false},{graphicWidth:32,graphicHeight:32,graphicOpacity:1,externalGraphic:self.icon,rotation:self.angle,label:self.title,labelAlign:'lm',labelXOffset:16,fontColor:"black",fontSize:"12px"});}
if(typeof soundManager!=='undefined'&&soundManager.ok()){var sound=soundManager.createSound({id:self.id,url:self.alarm,loops:1000000,autoLoad:false,autoPlay:false,multiShot:false,onload:function(){sound.stop();sound.play();}});this.alarmSound=sound;}
if(typeof io!=='undefined'&&this.host){this.socket=io.connect(this.host,{'force new connection':true});}
if(this.socket){this.socket.on('connect',Tian.Function.bind(this.onSocketConnect,this));this.socket.on('disconnect',Tian.Function.bind(this.onSocketDisconnect,this));this.socket.on('message',Tian.Function.bind(this.onSocketMessage,this));this.socket.on('devicedata',Tian.Function.bind(this.onSocketDeviceData,this));}
this.events=new Tian.Events(this,null,true);this.events.register('appdevicedata',this,this.onAppDeviceData);},destroy:function(){this.stopAlarm();if(this.socket){this.socket.disconnect();this.socket=null;}
if(this.window){this.window.close();this.window=null;}
if(this.events){this.events.destroy();this.events=null;}
if(this.feature){if(this.feature.layer){this.feature.layer.removeFeatures([this.feature]);}
if(this.feature.attributes){this.feature.attributes.device=null;}
this.feature.destroy();this.feature=null;}
if(this.alarmSound){this.alarmSound.destruct();this.alarmSound=null;}
this.os=null;this.lastDeviceData=null;},startAlarm:function(){if(this.alarmSound){this.alarmSound.play();}
if(!this.alarmTimer){this.alarmTimer=setInterval(Tian.Function.bind(this.doAlarm,this),this.alarmInterval);}},stopAlarm:function(){if(this.alarmSound){this.alarmSound.stop();}
if(this.alarmTimer){clearInterval(this.alarmTimer);this.alarmTimer=null;}
if(this.feature&&this.feature.style.graphicOpacity!==1){this.feature.style.graphicOpacity=1;this.feature.layer&&this.feature.layer.drawFeature(this.feature);}},doAlarm:function(){if(this.feature){if(this.feature.style.graphicOpacity===1){this.feature.style.graphicOpacity=0.2;this.feature.layer&&this.feature.layer.drawFeature(this.feature);}else{this.feature.style.graphicOpacity=1;this.feature.layer&&this.feature.layer.drawFeature(this.feature);}}},getID:function(){return this.id;},getKey:function(){return this.key;},setOS:function(os){if(!this.os){this.os=os;}},getOS:function(){return this.os;},getEvents:function(){return this.events;},getLastDeviceData:function(){return this.lastDeviceData;},setTitle:function(title){if(typeof title==='string'&&title!==this.title){this.title=title;if(this.feature){this.feature.style.label=this.title;this.feature.layer&&this.feature.layer.drawFeature(this.feature);}
this.window&&this.window.setTitle(title);}},getTitle:function(){return this.title;},setIcon:function(icon){if(typeof icon==='string'&&icon!==this.icon){this.icon=icon;if(this.feature){this.feature.style.externalGraphic=this.icon;this.feature.layer&&this.feature.layer.drawFeature(this.feature);}
this.window&&this.window.setIconImage(icon);}},setAlarm:function(alarm){if(typeof alarm==='string'&&alarm!==this.alarm){this.alarm=alarm;if(typeof soundManager!=='undefined'&&soundManager.ok()){if(this.alarmSound){this.alarmSound.destruct();this.alarmSound=null;}
this.alarmSound=soundManager.createSound({id:this.id,url:this.alarm,loops:1000000,autoLoad:false,autoPlay:false,multiShot:false,onload:function(){this.stop();this.play();}});}}},setPosition:function(lonlat,angle){if(this.feature&&Tian.Array.isArray(lonlat)&&lonlat.length===2){this.lonlat=lonlat;var point=new OpenLayers.Geometry.Point(this.lonlat[0],this.lonlat[1]).transform(this.os.getMap().displayProjection,this.os.getMap().getProjectionObject());this.feature.geometry.x=point.x;this.feature.geometry.y=point.y;if(typeof angle==='number'&&angle!==this.angle){this.angle=angle;this.feature.style.rotation=this.angle;}
this.feature.geometry.calculateBounds();this.feature.layer&&this.feature.layer.drawFeature(this.feature);}},onSelect:function(){this.stopAlarm();if(this.window){this.window.select();return;}
if(!this.os){return;}
var wm=this.os.getWindowManager();var ww=null,wh=null,wx=null,wy=null;ww=Tian.DB.get(Tian.md5(this.id+'_ww'));wh=Tian.DB.get(Tian.md5(this.id+'_wh'));wx=Tian.DB.get(Tian.md5(this.id+'_wx'));wy=Tian.DB.get(Tian.md5(this.id+'_wy'));this.window=wm.createWindow({title:this.title,state:'window',width:ww?ww:this.width,height:wh?wh:this.height,x:wx?wx:null,y:wy?wy:null,iconImageURL:this.icon,closeConfirm:Tian.i18n('txDeviceConfirm')});this.window.onclose=Tian.Function.bind(this.onWinClose,this);this.window.onmove=Tian.Function.bind(this.onWinMove,this);this.window.onresize=Tian.Function.bind(this.onWinResize,this);if(this.page){this.window.loadUrlX(this.page,Tian.Function.bind(this.onWinLoad,this));}},onSocketConnect:function(){this.socket.emit('subscribe',{id:this.id,key:this.key});this.events.triggerEvent('socketconnect');if(this.os){this.os.notify(this.title+' online');}},onSocketDisconnect:function(){this.events.triggerEvent('socketdisconnect');if(this.os){this.os.notify(this.title+' offline');}},onSocketMessage:function(msg){this.events.triggerEvent('socketmessage',{message:msg});},onSocketDeviceData:function(data){if(!data||data.id!==this.id){return;}
if(data.type==='devicertdata'){if(data.lonlat){this.setPosition(data.lonlat,data.angle);}
if(data.alarm){this.startAlarm();if(this.os){this.os.notify(Tian.i18n('txDevice')+' ['+this.title+'] '+Tian.i18n('txDeviceAlarm'));}}else{this.stopAlarm();}
this.lastDeviceData=data;}
this.events.triggerEvent('socketdevicedata',{devicedata:data});},onAppDeviceData:function(event){if(this.socket&&event&&event.devicedata){this.socket.emit('devicedata',event.devicedata);}},onWinLoad:function(window){if(!window){return;}
var theFrame=window.getElement('theFrame');if(theFrame&&theFrame.contentWindow&&typeof theFrame.contentWindow.tianMain==='function'){this.theApp=theFrame.contentWindow.tianMain.call(theFrame.contentWindow,{app:this,win:window});}},onWinClose:function(){this.window=null;this.theApp=null;},onWinMove:function(x,y){Tian.DB.set(Tian.md5(this.id+'_wx'),x);Tian.DB.set(Tian.md5(this.id+'_wy'),y);},onWinResize:function(w,h,a){switch(a){case'resize':Tian.DB.set(Tian.md5(this.id+'_ww'),w);Tian.DB.set(Tian.md5(this.id+'_wh'),h);break;case'maximize':break;case'restore':break;}},CLASS_NAME:"Tian.Device"});Tian.Embeded=Tian.Class({theWin:null,theApp:null,dictionaries:null,initialize:function(options){this.theWin=(options&&options.win)?options.win:null;this.theApp=(options&&options.app)?options.app:null;if(this.theWin){this.theWin.onselect=top.Tian.Function.bind(this.onSelect,this);this.theWin.ondeselect=top.Tian.Function.bind(this.onDeselect,this);this.theWin.oniconize=top.Tian.Function.bind(this.onIconize,this);this.theWin.onhttperror=top.Tian.Function.bind(this.onHttpError,this);this.theWin.onunload=top.Tian.Function.bind(this.onUnload,this);}
this.onRun();},onRun:function(){},destroy:function(){this.theWin=null;this.theApp=null;this.dictionaries=null;},i18n:function(key){var dictionary=this.dictionaries&&this.dictionaries[top.Tian.Lang.getCode()];var message=dictionary&&dictionary[key];if(!message){message=key;}
return message;},setTitle:function(title){if(this.theApp){this.theApp.setTitle(title);}},setIcon:function(iconurl){if(this.theApp){this.theApp.setIcon(iconurl);}},getTitle:function(){if(this.theApp){return this.theApp.title;}
return'';},getOS:function(){if(this.theApp){return this.theApp.getOS();}
return null;},getMap:function(){var os=this.getOS();if(os){return os.getMap();}
return null;},onSelect:function(){},onDeselect:function(){},onIconize:function(){},onUnload:function(){this.destroy();return true;},onHttpError:function(xhr,url){},CLASS_NAME:"Tian.Embeded"});(function(global){if(typeof global!=='object'||typeof global.Class!=='function'||typeof global.Array!=='object'){return;}
var toHex=function(n){if(typeof n==='number'&&Math.floor(n)===n&&n>=0&&n<=255){if(n<16){return'0'+n.toString(16);}else{return n.toString(16);}}
return'';};var hexEncode=function(buffer){var str='';var i,len=buffer.length;for(i=0;i<len;i+=1){str+=toHex(buffer[i]);}
return(str);};var hexDecode=function(string){string=string.replace(/[^A-Fa-f0-9]/g,'');var buffer=[];for(var i=0,len=string.length;i<len;i+=2){buffer.push(parseInt(string.slice(i,i+2),16));}
return(buffer);};var I2A=['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','0','1','2','3','4','5','6','7','8','9','+','/'];var A2I=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51];var getA2I=function(c){return((0<=c)&&(c<A2I.length)?A2I[c]:-1);};var base64Encode=function(buf){var length=buf&&buf.length?buf.length:0;var groupCount=Math.floor(length/3);var remaining=length-3*groupCount;var str='';var idx=0;for(var i=0;i<groupCount;i++){var b0=buf[idx++]&0xff;var b1=buf[idx++]&0xff;var b2=buf[idx++]&0xff;str+=(I2A[b0>>2]);str+=(I2A[(b0<<4)&0x3f|(b1>>4)]);str+=(I2A[(b1<<2)&0x3f|(b2>>6)]);str+=(I2A[b2&0x3f]);}
if(remaining==1){var b0=buf[idx++]&0xff;str+=(I2A[b0>>2]);str+=(I2A[(b0<<4)&0x3f]);str+=("==");}else if(remaining==2){var b0=buf[idx++]&0xff;var b1=buf[idx++]&0xff;str+=(I2A[b0>>2]);str+=(I2A[(b0<<4)&0x3f|(b1>>4)]);str+=(I2A[(b1<<2)&0x3f]);str+=('=');}
return(str);};var base64Decode=function(str){var length=str&&str.length?str.length:0;var buf=[];var groupCount=Math.floor(length/4);if(4*groupCount!==length){return(buf);}
var missing=0;if(length>0){if(str.charAt(length-1)==='='){missing+=1;groupCount-=1;}
if(str.charAt(length-2)==='='){missing+=1;}}
var idx_in=0;for(var i=0;i<groupCount;i++){var c0=getA2I(str.charCodeAt(idx_in++));var c1=getA2I(str.charCodeAt(idx_in++));var c2=getA2I(str.charCodeAt(idx_in++));var c3=getA2I(str.charCodeAt(idx_in++));buf.push(0xFF&((c0<<2)|(c1>>4)));buf.push(0xFF&((c1<<4)|(c2>>2)));buf.push(0xFF&((c2<<6)|c3));}
if(missing==1){var c0=getA2I(str.charCodeAt(idx_in++));var c1=getA2I(str.charCodeAt(idx_in++));var c2=getA2I(str.charCodeAt(idx_in++));buf.push(0xFF&((c0<<2)|(c1>>4)));buf.push(0xFF&((c1<<4)|(c2>>2)));}else if(missing==2){var c0=getA2I(str.charCodeAt(idx_in++));var c1=getA2I(str.charCodeAt(idx_in++));buf.push(0xFF&((c0<<2)|(c1>>4)));}
return(buf);};var readIEEE754=function(buf,offset,isBE,mLen,nBytes){var e,m,eLen=nBytes*8-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isBE?0:(nBytes-1),d=isBE?1:-1,s=buf[offset+i];i+=d;e=s&((1<<(-nBits))-1);s>>=(-nBits);nBits+=eLen;for(;nBits>0;e=e*256+buf[offset+i],i+=d,nBits-=8);m=e&((1<<(-nBits))-1);e>>=(-nBits);nBits+=mLen;for(;nBits>0;m=m*256+buf[offset+i],i+=d,nBits-=8);if(e===0){e=1-eBias;}else if(e===eMax){return m?NaN:((s?-1:1)*Infinity);}else{m=m+Math.pow(2,mLen);e=e-eBias;}
return(s?-1:1)*m*Math.pow(2,e-mLen);};var writeIEEE754=function(buf,value,offset,isBE,mLen,nBytes){var e,m,c,eLen=nBytes*8-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=(mLen===23?Math.pow(2,-24)-Math.pow(2,-77):0),i=isBE?(nBytes-1):0,d=isBE?-1:1,s=value<0||(value===0&&1/value<0)?1:0;value=Math.abs(value);if(isNaN(value)||value===Infinity){m=isNaN(value)?1:0;e=eMax;}else{e=Math.floor(Math.log(value)/Math.LN2);if(value*(c=Math.pow(2,-e))<1){e--;c*=2;}
if(e+eBias>=1){value+=rt/c;}else{value+=rt*Math.pow(2,1-eBias);}
if(value*c>=2){e++;c/=2;}
if(e+eBias>=eMax){m=0;e=eMax;}else if(e+eBias>=1){m=(value*c-1)*Math.pow(2,mLen);e=e+eBias;}else{m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen);e=0;}}
for(;mLen>=8;buf[offset+i]=m&0xff,i+=d,m/=256,mLen-=8);e=(e<<mLen)|m;eLen+=mLen;for(;eLen>0;buf[offset+i]=e&0xff,i+=d,e/=256,eLen-=8);buf[offset+i-d]|=s*128;};global.Buffer=global.Class({buffer:null,initialize:function(obj,encoding){var i,len;if(typeof obj==='number'){this.buffer=[];len=parseInt(obj,10);for(i=0;i<len;i+=1){this.buffer.push(0);}}else if(global.Array.isArray(obj)){this.buffer=obj;}else if(typeof obj==='string'){switch(encoding){case'hex':this.buffer=hexDecode(obj);break;case'base64':this.buffer=base64Decode(obj);break;default:this.buffer=hexDecode(obj);}}else{this.buffer=[];}},getLength:function(){return this.buffer.length;},toString:function(encoding){switch(encoding){case'hex':return hexEncode(this.buffer);case'base64':return base64Encode(this.buffer);default:return hexEncode(this.buffer);}
return'';},verify:function(value,type){switch(type){case'offset':return(typeof value==='number'&&value>=0&&value<this.buffer.length&&Math.floor(value)===value);case'char':return(typeof value==='string'&&value.length===1&&value.charCodeAt(0)<0x80);case'string':return(typeof value==='string'&&value.length>0);case'uint8':return(typeof value==='number'&&value>=0&&value<=0xff&&Math.floor(value)===value);case'uint16':return(typeof value==='number'&&value>=0&&value<=0xffff&&Math.floor(value)===value);case'uint32':return(typeof value==='number'&&value>=0&&value<=0xffffffff&&Math.floor(value)===value);case'int8':return(typeof value==='number'&&value>=-0x80&&value<=0x7f&&Math.floor(value)===value);case'int16':return(typeof value==='number'&&value>=-0x8000&&value<=0x7fff&&Math.floor(value)===value);case'int32':return(typeof value==='number'&&value>=-0x80000000&&value<=0x7fffffff&&Math.floor(value)===value);case'float':return(typeof value==='number'&&value>=-3.4028234663852886e+38&&value<=3.4028234663852886e+38);case'double':return(typeof value==='number'&&value>=-1.7976931348623157E+308&&value<=1.7976931348623157E+308);default:return false;}},getChar:function(offset){if(this.verify(offset,'offset')){return String.fromCharCode(this.buffer[offset]);}
return undefined;},setChar:function(value,offset){if(this.verify(value,'char')&&this.verify(offset,'offset')){this.buffer[offset]=value.charCodeAt(0);return true;}
return false;},getString:function(offset,length){var str='',i,c;if(this.verify(offset,'offset')&&this.verify(offset+length-1,'offset')){length=offset+length;for(i=offset;i<length;){c=this.buffer[i++];if(c<0x80){str+=String.fromCharCode(c);}else if(c<0xE0){str+=String.fromCharCode(((0x1F&c)<<6)|((0x3F&this.buffer[i++])<<0));}else if(c<0xF0){str+=String.fromCharCode(((0x0F&c)<<12)|((0x3F&this.buffer[i++])<<6)|((0x3F&this.buffer[i++])<<0));}else if(c<0xF8){str+=String.fromCharCode(((0x07&c)<<18)|((0x3F&this.buffer[i++])<<12)|((0x3F&this.buffer[i++])<<6)|((0x3F&this.buffer[i++])<<0));}else if(c<0xFC){str+=String.fromCharCode(((0x03&c)<<24)|((0x3F&this.buffer[i++])<<18)|((0x3F&this.buffer[i++])<<12)|((0x3F&this.buffer[i++])<<6)|((0x3F&this.buffer[i++])<<0));}else if(c<0xFE){str+=String.fromCharCode(((0x01&c)<<30)|((0x3F&this.buffer[i++])<<24)|((0x3F&this.buffer[i++])<<18)|((0x3F&this.buffer[i++])<<12)|((0x3F&this.buffer[i++])<<6)|((0x3F&this.buffer[i++])<<0));}}
return(str);}
return undefined;},setString:function(value,offset){var i,len,c,buf=[];if(!this.verify(value,'string')||!this.verify(offset,'offset')){return false;}
for(i=0,len=value.length;i<len;i++){c=value.charCodeAt(i);if(c<0x80){buf.push(c);}else if(c<0x800){buf.push(0xC0|((c&0x7C0)>>>6));buf.push(0x80|(c&0x3F));}else if(c<0x10000){buf.push(0xE0|((c&0xF000)>>>12));buf.push(0x80|((c&0xFC0)>>>6));buf.push(0x80|(c&0x3F));}else{buf.push(0xF0|((c&0x1C0000)>>>18));buf.push(0x80|((c&0x3F000)>>>12));buf.push(0x80|((c&0xFC0)>>>6));buf.push(0x80|(c&0x3F));}}
if(this.verify(offset+buf.length-1,'offset')){for(i=0,len=buf.length;i<len;i++){this.buffer[offset+i]=buf[i];}
return true;}
return false;},getUInt8:function(offset){if(this.verify(offset,'offset')){return(this.buffer[offset]);}
return undefined;},setUInt8:function(value,offset){if(this.verify(value,'uint8')&&this.verify(offset,'offset')){this.buffer[offset]=value;return true;}
return false;},getUInt16:function(offset,bigEndian){var val=0;if(this.verify(offset,'offset')&&this.verify(offset+1,'offset')){if(bigEndian){val=this.buffer[offset]<<8;val|=this.buffer[offset+1];}else{val=this.buffer[offset];val|=this.buffer[offset+1]<<8;}
return(val);}
return undefined;},setUInt16:function(value,offset,bigEndian){if(this.verify(value,'uint16')&&this.verify(offset,'offset')&&this.verify(offset+1,'offset')){if(bigEndian){this.buffer[offset]=(value&0xff00)>>>8;this.buffer[offset+1]=value&0x00ff;}else{this.buffer[offset+1]=(value&0xff00)>>>8;this.buffer[offset]=value&0x00ff;}
return true;}
return false;},getUInt32:function(offset,bigEndian){var val=0;if(this.verify(offset,'offset')&&this.verify(offset+3,'offset')){if(bigEndian){val=this.buffer[offset+1]<<16;val|=this.buffer[offset+2]<<8;val|=this.buffer[offset+3];val=val+(this.buffer[offset]<<24>>>0);}else{val=this.buffer[offset+2]<<16;val|=this.buffer[offset+1]<<8;val|=this.buffer[offset];val=val+(this.buffer[offset+3]<<24>>>0);}
return(val);}
return undefined;},setUInt32:function(value,offset,bigEndian){if(this.verify(value,'uint32')&&this.verify(offset,'offset')&&this.verify(offset+3,'offset')){if(bigEndian){this.buffer[offset]=(value>>>24)&0xff;this.buffer[offset+1]=(value>>>16)&0xff;this.buffer[offset+2]=(value>>>8)&0xff;this.buffer[offset+3]=value&0xff;}else{this.buffer[offset+3]=(value>>>24)&0xff;this.buffer[offset+2]=(value>>>16)&0xff;this.buffer[offset+1]=(value>>>8)&0xff;this.buffer[offset]=value&0xff;}
return true;}
return false;},getInt8:function(offset){if(this.verify(offset,'offset')){if(this.buffer[offset]&0x80){return((0xff-this.buffer[offset]+1)*-1);}else{return(this.buffer[offset]);}}
return undefined;},setInt8:function(value,offset){if(this.verify(value,'int8')&&this.verify(offset,'offset')){if(value>=0){return this.setUInt8(value,offset);}else{return this.setUInt8(0xff+value+1,offset);}}
return false;},getInt16:function(offset,bigEndian){var val=0;if(this.verify(offset,'offset')&&this.verify(offset+1,'offset')){val=this.getUInt16(offset,bigEndian);if(val&0x8000){val=(0xffff-val+1)*-1;}
return(val);}
return undefined;},setInt16:function(value,offset,bigEndian){if(this.verify(value,'int16')&&this.verify(offset,'offset')&&this.verify(offset+1,'offset')){if(value>=0){return this.setUInt16(value,offset,bigEndian);}else{return this.setUInt16(0xffff+value+1,offset,bigEndian);}}
return false;},getInt32:function(offset,bigEndian){var val=0;if(this.verify(offset,'offset')&&this.verify(offset+3,'offset')){val=this.getUInt32(offset,bigEndian);if(val&0x80000000){val=(0xffffffff-val+1)*-1;}
return(val);}
return undefined;},setInt32:function(value,offset,bigEndian){if(this.verify(value,'int32')&&this.verify(offset,'offset')&&this.verify(offset+3,'offset')){if(value>=0){return this.setUInt32(value,offset,bigEndian);}else{return this.setUInt32(0xffffffff+value+1,offset,bigEndian);}}
return false;},getFloat:function(offset,bigEndian){if(this.verify(offset,'offset')&&this.verify(offset+3,'offset')){return readIEEE754(this.buffer,offset,bigEndian,23,4);}
return undefined;},setFloat:function(value,offset,bigEndian){if(this.verify(value,'float')&&this.verify(offset,'offset')&&this.verify(offset+3,'offset')){writeIEEE754(this.buffer,value,offset,bigEndian,23,4);return true;}
return false;},getDouble:function(offset,bigEndian){if(this.verify(offset,'offset')&&this.verify(offset+7,'offset')){return readIEEE754(this.buffer,offset,bigEndian,52,8);}
return undefined;},setDouble:function(value,offset,bigEndian){if(this.verify(value,'double')&&this.verify(offset,'offset')&&this.verify(offset+7,'offset')){writeIEEE754(this.buffer,value,offset,bigEndian,52,8);return true;}
return false;}});})(window.Tian);Tian.Lang.add('en','txMainPanelTitle','Main Panel');Tian.Lang.add('en','txMainPanelConfirm','Press [OK] to close, or [Cancel] to minimize the window.');Tian.Lang.add('zh-CN','txMainPanelTitle','');Tian.Lang.add('zh-CN','txMainPanelConfirm','');Tian.Widget.MainPanel=Tian.Class(Tian.Widget,{mainDiv:null,window:null,windowOpened:false,width:540,height:300,apps:null,initialize:function(){Tian.Widget.prototype.initialize.apply(this,arguments);this.title=Tian.i18n('txMainPanelTitle');this.apps=[];},draw:function(){Tian.Widget.prototype.draw.apply(this,arguments);this.div.className='txWidgetMainPanel txWidgetNoSelect';this.mainDiv=document.createElement('div');this.mainDiv.className='txWidgetMainPanelContent';Tian.Event.observe(this.div,"click",Tian.Function.bindAsEventListener(this.onClick,this));return this.div;},destroy:function(){if(this.apps){for(var i=this.apps.length-1;i>=0;i--){this.delApp(this.apps[i]);this.apps[i].destroy();}
this.apps=null;}
if(this.windowOpened){this.window.close();this.window=null;this.windowOpened=false;}
if(this.mainDiv){this.mainDiv=null;}
Tian.Event.stopObservingElement(this.div);Tian.Widget.prototype.destroy.apply(this,arguments);},onClick:function(evt){if(evt){Tian.Event.stop(evt);}
if(this.windowOpened){this.window.select();return;}
if(!this.os){return;}
var wm=this.os.getWindowManager();var ww=null,wh=null,wx=null,wy=null;ww=Tian.DB.get(Tian.md5(this.title+'_ww'));wh=Tian.DB.get(Tian.md5(this.title+'_wh'));wx=Tian.DB.get(Tian.md5(this.title+'_wx'));wy=Tian.DB.get(Tian.md5(this.title+'_wy'));this.window=wm.createWindow({title:this.title,centered:true,state:'window',width:ww?ww:this.width,height:wh?wh:this.height,x:wx?wx:null,y:wy?wy:null,iconImageURL:(this.getOS().getImagePath()+'main_icon.png'),closeConfirm:Tian.i18n('txMainPanelConfirm')});this.windowOpened=true;this.window.getComponent('content').innerHTML='';this.window.getComponent('content').appendChild(this.mainDiv);this.window.getComponent('content').style.overflow='auto';this.window.onclose=Tian.Function.bind(this.onWinClose,this);this.window.onmove=Tian.Function.bind(this.onWinMove,this);this.window.onresize=Tian.Function.bind(this.onWinResize,this);},onWinClose:function(isClose){this.window=null;this.windowOpened=false;},onWinMove:function(x,y){Tian.DB.set(Tian.md5(this.title+'_wx'),x);Tian.DB.set(Tian.md5(this.title+'_wy'),y);},onWinResize:function(w,h,a){switch(a){case'resize':Tian.DB.set(Tian.md5(this.title+'_ww'),w);Tian.DB.set(Tian.md5(this.title+'_wh'),h);break;case'maximize':break;case'restore':break;}},addApp:function(app){if(app instanceof Tian.App){app.setOS(this.os);this.mainDiv.appendChild(app.draw());this.apps.push(app);}},delApp:function(app){if(app instanceof Tian.App){this.mainDiv.removeChild(app.div);Tian.Array.removeItem(this.apps,app);if(app.active&&app.window){app.window.close();app.window=null;app.active=false;}}},clearApps:function(){if(this.apps){for(var i=this.apps.length-1;i>=0;i--){this.delApp(this.apps[i]);this.apps[i].destroy();}
this.apps=[];}},getAllApps:function(){return this.apps;},CLASS_NAME:"Tian.Widget.MainPanel"});Tian.Lang.add('en','txTitleBarWelcome','Welcome: ');Tian.Lang.add('en','txTitleBarAnonymous','Sign in');Tian.Lang.add('zh-CN','txTitleBarWelcome',': ');Tian.Lang.add('zh-CN','txTitleBarAnonymous','');Tian.Widget.TitleBar=Tian.Class(Tian.Widget,{spanWelcome:null,spanAccount:null,spanNotify:null,notifications:null,initialize:function(){Tian.Widget.prototype.initialize.apply(this,arguments);this.notifications=[];},draw:function(){Tian.Widget.prototype.draw.apply(this,arguments);this.div.className='txWidgetTitleBar txWidgetNoSelect';this.spanWelcome=document.createElement('span');this.spanWelcome.className='txWidgetTitleBarWelcome';this.spanWelcome.innerHTML=Tian.i18n('txTitleBarWelcome');this.div.appendChild(this.spanWelcome);this.spanAccount=document.createElement('span');this.spanAccount.className='txWidgetTitleBarAccount';this.spanAccount.innerHTML=Tian.i18n('txTitleBarAnonymous');this.div.appendChild(this.spanAccount);Tian.Event.observe(this.spanAccount,'click',Tian.Function.bindAsEventListener(this.onAccount,this));this.spanNotify=document.createElement('span');this.spanNotify.className='txWidgetTitleBarNotification';this.div.appendChild(this.spanNotify);Tian.Event.observe(this.spanNotify,'click',Tian.Function.bindAsEventListener(this.onNotify,this));return this.div;},destroy:function(){Tian.Event.stopObservingElement(this.spanAccount);Tian.Event.stopObservingElement(this.spanNotify);this.notifications=null;Tian.Widget.prototype.destroy.apply(this,arguments);},setAccount:function(account){if(typeof account==='string'){this.spanAccount.innerHTML=account;}},notify:function(notification){if(typeof notification==='string'){this.spanNotify.innerHTML=notification;var notify=Tian.Date.format(new Date(),'yyyy-mm-dd HH:MM:SS - ')+notification;this.os.getEvents().triggerEvent('notify',{notification:notify});this.notifications.push(notify);}},clearNotifications:function(){this.spanNotify.innerHTML='';this.notifications=[];},onAccount:function(evt){if(!this.os){return;}
var apps=this.os.getMainPanel().getAllApps();if(apps){for(var i=0;i<apps.length;i++){if(apps[i]instanceof Tian.App&&apps[i].page.indexOf('apps/account/index.html')!==-1){apps[i].onOpen();break;}}}
if(evt!=null){Tian.Event.stop(evt);}},onNotify:function(evt){if(!this.os){return;}
var apps=this.os.getMainPanel().getAllApps();if(apps){for(var i=0;i<apps.length;i++){if(apps[i]instanceof Tian.App&&apps[i].page.indexOf('apps/notification/index.html')!==-1){apps[i].onOpen();break;}}}
if(evt!=null){Tian.Event.stop(evt);}},CLASS_NAME:"Tian.Widget.TitleBar"});Tian.Winager=Tian.Class({windows:null,winSelected:null,winDragging:null,mouse:null,opts:null,initialize:function(options){this.windows=[];this.mouse={cur:{x:0,y:0},click:{x:0,y:0}};this.opts={classWindow:'txWindow',classActiveWindow:'txWindowActive',classContent:(Tian.BROWSER==='safari'?'txWinContentSafari':'txWinContent'),classFrame:'txWinFrame',classTitle:'txWinTitle txWidgetNoSelect',classIcon:'txWinTaskBarIcon',classActiveIcon:'txWinTaskBarIconActive',baseZIndex:5000,taskbar:null,container:document.body,iconImageURL:'',defaultX:32,defaultY:32,defaultWidth:500,defaultHeight:300,shiftOffset:32,movable:true,httpErrorHandler:null,containerBoundaries:64,iconWidth:36,resizeIcons:true,afterLoad:null,cacheXHR:false};Tian.extend(this.opts,options);Tian.Event.observe(window,'resize',Tian.Function.bind(this.checkResize,this));},destroy:function(){Tian.Event.stopObserving(window,'resize',Tian.Function.bind(this.checkResize,this));var wins=this.getAllWindows();for(var i=0;i<wins.length;i++){wins[i].close();wins[i]=undefined;}},checkResize:function(){for(var a=0;a<this.windows.length;a++){if(this.windows[a].state!='maximized'){continue;}
var Dw=this.windows[a].win.offsetWidth-parseInt(this.windows[a].win.style.width);var Dh=this.windows[a].win.offsetHeight-parseInt(this.windows[a].win.style.height);var w=this.windows[a].getContainerWidth()-Dw;var h=this.windows[a].getContainerHeight()-Dh;this.windows[a]._setSize(w,h,false,'resize');}
this._resizeIcons();},_resizeIcons:function(){var gs=function(e,p){var n=parseInt(Tian.getStyle(e,p));return(isNaN(n)?0:n);};var a,icns=[];for(a=0;a<this.windows.length;a++){if(this.windows[a].taskbarIcon&&this.windows[a].taskbarIcon.parentNode==this.opts.taskbar){icns.push(this.windows[a].taskbarIcon);}}
if(icns.length<1)return;var tbw=this.opts.taskbar.clientWidth-gs(this.opts.taskbar,'padding-left')-
gs(this.opts.taskbar,'padding-right')-1;var iw=parseInt(tbw/icns.length);for(a=0;a<icns.length;a++){var Dw=(icns[a].offsetWidth+gs(icns[a],'margin-left')+
gs(icns[a],'margin-right'))-gs(icns[a],'width');if((this.opts.iconWidth+Dw)>iw){icns[a].style.width=(iw-Dw-1)+'px';}else{icns[a].style.width=this.opts.iconWidth+'px';}}},createWindow:function(opts){opts=opts||{};if(opts.id&&this.getWindow(opts.id)!=null){return null;}
var container=opts.container||this.opts.container;var state=opts.state||this.opts.defaultState;var w=new Tian.Window(opts,this);w.win=document.createElement('div');w.content=document.createElement('div');if(this.opts.shiftOffset>0){var a;do{for(a=0;a<this.windows.length;a++){var p=this.windows[a];if((p.x===w.x||p.userX===w.x)&&(p.y===w.y||p.userY===w.y)){w.x+=this.opts.shiftOffset;w.y+=this.opts.shiftOffset;break;}}}while(a!=this.windows.length);}
w.userX=w.x;w.userY=w.y;w.win.className=this.opts.classWindow;w.win.style.cssText="z-index:"+this.opts.baseZIndex+";position:absolute;top:"+(w.y)+"px;left:"+(w.x)+"px;";w.content.className=this.opts.classContent;w.content.style.cssText='position:relative;margin:0;width:0px;height:0px';w.title=document.createElement('div');w.title.className=this.opts.classTitle;w.components.iconImage=document.createElement('img');w.components.iconImage.className='txWinIconImage';w.components.iconImage.src=w.iconImageURL;w.title.appendChild(w.components.iconImage);w.titleSpan=document.createElement('div');w.titleSpan.className='txWinTitleText';w.titleSpan.innerHTML=w.titleText;w.title.appendChild(w.titleSpan);w.components.close=document.createElement('div');w.components.close.className='txWinCloseBox';w.title.appendChild(w.components.close);w.components.maximizer=document.createElement('div');w.components.maximizer.className='txWinMaxBox';w.title.appendChild(w.components.maximizer);if(this.opts.taskbar){w.components.iconizer=document.createElement('div');w.components.iconizer.className='txWinMinBox';w.title.appendChild(w.components.iconizer);}
w.win.appendChild(w.title);w.components.titlebar=w.title;w.win.appendChild(w.content);w.components.content=w.content;w.loading=document.createElement('div');w.loading.className='txWinLoading';if(w.title){w.title.appendChild(w.loading);}else{w.win.appendChild(w.loading);}
w.components.loading=w.loading;container.appendChild(w.win);w.components.window=w.win;w._setSize(w.w,w.h,false,'');this.windows.push(w);if(this.opts.taskbar){w._createTaskbarIcon();}
this._selectWindow(w,true);if(state!='window'){w.setState(state);}
w.attachEvents();w.closeConfirm=opts.closeConfirm||'';return w;},getWindow:function(id){var a
for(var a=0;a<this.windows.length;a++){if(this.windows[a].id==id){return this.windows[a];}}
return null;},getSelectedWindow:function(){return this.selectedWindow;},getAllWindows:function(){var ret=[];for(var a=this.windows.length-1;a>=0;a--){ret.push(this.windows[a]);}
return ret;},getContainerHeight:function(){if(this.opts.container===document.body){return this.getBodySize().height;}
return this.opts.container.clientHeight;},getContainerWidth:function(){if(this.opts.container==document.body){return this.getBodySize().width;}
return this.opts.container.clientWidth;},_getFirstVisibleWindow:function(){for(var a=(this.windows.length-1);a>=0;a--){if(this.windows[a].win.style.visibility!='hidden')return this.windows[a];}
return null;},_selectWindow:function(win){if(win==this.selectedWindow)return;if(this.selectedWindow&&this.selectedWindow.ondeselect)this.selectedWindow.ondeselect();if(!win.alwaysOnTop){for(var a=0;a<this.windows.length;a++){if(this.windows[a]==win){var tmp=this.windows.splice(a,1);for(var b=this.windows.length-1;b>=0;b--){if(!this.windows[b].alwaysOnTop)break;}
this.windows.splice(b+1,0,tmp[0]);break;}}}
for(var a=0;a<this.windows.length;a++){this.windows[a].win.style.zIndex=(this.opts.baseZIndex+a);this.windows[a].win.className=this.opts.classWindow;if(this.windows[a].taskbarIcon)this.windows[a].taskbarIcon.className=this.opts.classIcon;}
win.win.style.display='';win.win.style.visibility='visible';win.win.className=this.opts.classActiveWindow;if(win.taskbarIcon)win.taskbarIcon.className=this.opts.classActiveIcon;this.selectedWindow=win;if(win.state=='icon'||win.state=='hidden'){win.state=win.prvState;win.prvState=null;}
if(win.onselect)win.onselect();},_destroyWindow:function(w){for(var a=0;a<this.windows.length;a++){if(this.windows[a]==w){if(!this.windows[a]._unload(false)){return false;}
this.windows[a].getContainer().removeChild(this.windows[a].win);if(this.windows[a].taskbarIcon!=null){this.windows[a]._removeTaskbarIcon();}
var closed=this.windows.splice(a,1)[0];for(var b=0;b<this.windows.length;b++){this.windows[b].win.style.zIndex=(this.opts.baseZIndex+b);}
if(typeof closed.onclose==='function'){closed.onclose();closed.onclose=null;}
closed=null;var fw=this._getFirstVisibleWindow();if(fw)fw.select();return;}}
return null;},handleBrowserEvent:function(evt){var touches=evt.touches;if(touches&&touches[0]){var x=0;var y=0;var num=touches.length;var touch;for(var i=0;i<num;++i){touch=touches[i];x+=touch.clientX;y+=touch.clientY;}
evt.clientX=x/num;evt.clientY=y/num;}
return evt;},getEventXY:function(evt,element){evt=this.handleBrowserEvent(evt);if(!element.scrolls){var viewportElement=Tian.getViewportElement();element.scrolls=[viewportElement.scrollLeft,viewportElement.scrollTop];}
if(!element.lefttop){element.lefttop=[(document.documentElement.clientLeft||0),(document.documentElement.clientTop||0)];}
if(!element.offsets){element.offsets=Tian.pagePosition(element);}
var xy={x:(evt.clientX+element.scrolls[0])-element.offsets[0]-element.lefttop[0],y:(evt.clientY+element.scrolls[1])-element.offsets[1]-element.lefttop[1]};return xy;},getBodySize:function(){var w=(window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth);var h=(window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight);return{width:w,height:h};},CLASS_NAME:"Tian.Winager"});